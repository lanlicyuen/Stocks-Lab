# 证券主档功能 - 快速参考

## 🎯 核心概念

**Security（证券主档）** = 股票代码 + 公司信息 + 行业分类

- **作用**：统一管理股票信息，避免重复录入
- **关联**：每笔交易自动关联到证券主档
- **统计**：支持按行业分类进行交易复盘

## 📝 使用场景

### 场景 1：首次交易新股票
```
1. 输入股票代码: AAPL
2. 系统提示: "首次交易此标的，请补充信息"
3. 填写:
   - 公司全名: Apple Inc.
   - 行业分类: 科技
   - 二级行业: 消费电子（可选）
4. 提交 → 自动创建 Security + Trade
```

### 场景 2：再次交易已有股票
```
1. 输入股票代码: AAPL
2. 系统显示:
   公司名称: Apple Inc.
   行业分类: 科技
   二级行业: 消费电子
3. 直接填写交易详情 → 提交
```

### 场景 3：查看分类复盘
```
项目 Dashboard → 分类复盘统计
├── 选择时间范围（最近30天）
├── 选择行业（可选）
├── 点击查询
└── 查看:
    ├── 统计概览（总交易/买入/卖出/净流量）
    ├── 行业汇总（按行业分组）
    └── 股票明细（每只股票详情）
```

## 🔑 关键 API

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/v1/securities/` | GET | 获取证券列表 |
| `/api/v1/securities/` | POST | 创建证券（ADMIN） |
| `/api/v1/securities/check-symbol/` | GET | 检查股票代码是否存在 |
| `/api/v1/securities/trade-summary/` | GET | 交易汇总统计 |

## 📊 统计指标

| 指标 | 计算方式 | 说明 |
|------|----------|------|
| 买入总额 | Σ(买入数量 × 买入价格) | 所有买入交易的金额总和 |
| 卖出总额 | Σ(卖出数量 × 卖出价格) | 所有卖出交易的金额总和 |
| 净流量 | 卖出总额 - 买入总额 | 正数=净流入，负数=净流出 |
| 交易次数 | COUNT(交易记录) | 所选时间段内的交易笔数 |

## 🎨 前端页面

| 页面 | 路径 | 功能 |
|------|------|------|
| 增强版交易表单 | `/trades/create/?project={id}` | 自动检测股票代码 + 补充信息 |
| 分类复盘统计 | `/trades/analysis/?project={id}` | 按行业/时间查看交易表现 |
| 项目 Dashboard | `/projects/{id}/dashboard/` | 快速入口：分类复盘按钮 |

## 🛡️ 权限矩阵

| 操作 | ADMIN | VIEWER |
|------|-------|--------|
| 查看证券列表 | ✅ | ✅ |
| 查看统计报表 | ✅ | ✅ |
| 创建交易（自动创建证券） | ✅ | ❌ |
| 编辑证券信息 | ✅ | ❌ |

## 💡 最佳实践

1. **统一行业分类标准**
   - 建议使用 GICS 或自定义标准
   - 保持分类一致性，便于统计

2. **完整填写公司信息**
   - 首次交易时务必填写完整
   - 避免后续统计出现问题

3. **定期查看复盘统计**
   - 按月度/季度查看行业配置
   - 识别重仓行业和资金流向

4. **合理使用时间筛选**
   - 短期：查看最近交易表现
   - 长期：评估整体投资策略

## 🐛 常见问题

**Q: 股票代码自动检测不工作？**
A: 确保项目ID正确传递，检查浏览器控制台错误

**Q: 统计数据不准确？**
A: 检查时间范围格式，确认所有交易都关联了 Security

**Q: 无法创建证券？**
A: 确认用户角色为 ADMIN，检查股票代码是否已存在

**Q: 如何更新证券信息？**
A: 目前需要通过 Django Admin 或 API 更新

## 📦 数据结构

```python
# Security（证券主档）
{
    "id": 1,
    "project": 1,
    "symbol": "AAPL",           # 股票代码（大写）
    "name": "Apple Inc.",       # 公司全名
    "sector": "科技",            # 一级行业
    "industry": "消费电子",      # 二级行业（可选）
    "trade_count": 5            # 关联交易数
}

# Trade（交易记录）
{
    "id": 1,
    "project": 1,
    "security": 1,              # 关联证券主档
    "security_info": {...},     # 证券详情（自动填充）
    "symbol": "AAPL",           # 股票代码（冗余字段）
    "side": "BUY",
    "price": 180.50,
    "quantity": 100,
    "executed_at": "2025-12-27T10:30:00"
}

# 统计结果
{
    "by_security": [            # 按股票明细
        {
            "sector": "科技",
            "symbol": "AAPL",
            "name": "Apple Inc.",
            "trade_count": 5,
            "buy_total": 10000.00,
            "sell_total": 12000.00,
            "net_flow": 2000.00
        }
    ],
    "by_sector": [              # 按行业汇总
        {
            "sector": "科技",
            "symbol_count": 3,
            "trade_count": 15,
            "buy_total": 50000.00,
            "sell_total": 55000.00,
            "net_flow": 5000.00
        }
    ]
}
```

## 🚀 快速开始

```bash
# 1. 访问项目 Dashboard
http://stocks.1plabs.pro/projects/1/dashboard/

# 2. 点击"新增交易记录"
# 3. 输入股票代码，系统自动检测
# 4. 首次交易填写公司信息
# 5. 提交后返回 Dashboard

# 6. 查看分类复盘
点击"分类复盘统计" → 选择时间范围 → 查询
```

## 📈 示例流程

```
用户: 创建 AAPL 买入交易
  ↓
系统: 检查 AAPL 是否存在
  ↓
不存在 → 展开补充信息表单
  ↓
用户: 填写 Apple Inc. + 科技 + 消费电子
  ↓
系统: 创建 Security(AAPL) + Trade
  ↓
用户: 再次交易 AAPL
  ↓
系统: 显示公司信息（只读）
  ↓
用户: 直接填写交易详情
  ↓
系统: 创建 Trade（自动关联 Security）
  ↓
用户: 查看分类复盘
  ↓
系统: 按行业统计，显示科技板块交易表现
```

---

📚 **详细文档**: `SECURITY_FEATURE_GUIDE.md`  
🧪 **测试脚本**: `test_security_feature.sh`  
🌐 **访问地址**: http://stocks.1plabs.pro/
