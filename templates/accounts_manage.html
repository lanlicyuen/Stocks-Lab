{% extends 'base_new.html' %}

{% block title %}è´¦æˆ·ç®¡ç† - æŠ•èµ„é¡¹ç›®æŠ«éœ²å¹³å°{% endblock %}

{% block content %}
<div class="desktop-nav">
    <a href="{% url 'dashboard' %}">é¦–é¡µ</a>
    <a href="{% url 'account_settings' %}">ç”¨æˆ·è®¾ç½®</a>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">è´¦æˆ·ç®¡ç†</h2>
        <button class="btn btn-primary btn-sm" onclick="window.location.href='/'">+ æ–°å¢è´¦æˆ·</button>
    </div>
    <div class="card-body">
        <div id="accountsList">
            <div class="loading">
                <div class="spinner"></div>
                <div>åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>ç¡®è®¤åˆ é™¤</h3>
            <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>ç¡®å®šè¦åˆ é™¤è´¦æˆ· <strong id="deleteAccountName"></strong> å—ï¼Ÿ</p>
            <p style="color: #dc3545; font-size: 14px;">âš ï¸ æ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥è´¦æˆ·ä¸‹çš„æ‰€æœ‰æ ‡çš„å’Œäº¤æ˜“è®°å½•ï¼Œä¸”æ— æ³•æ¢å¤ï¼</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
        </div>
    </div>
</div>

<style>
.loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: #666;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.account-item {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: white;
    transition: box-shadow 0.3s;
}

.account-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.account-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.account-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
}

.account-actions {
    display: flex;
    gap: 8px;
}

.account-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    font-size: 14px;
}

.account-info-item {
    display: flex;
    flex-direction: column;
}

.account-info-label {
    color: #666;
    font-size: 12px;
    margin-bottom: 4px;
}

.account-info-value {
    color: #333;
    font-weight: 500;
}

.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.badge-primary {
    background: #007bff;
    color: white;
}

.badge-success {
    background: #28a745;
    color: white;
}

.badge-warning {
    background: #ffc107;
    color: #000;
}

.btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 13px;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.modal-content {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    width: 90%;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #999;
    padding: 0;
    width: 30px;
    height: 30px;
}

.close-btn:hover {
    color: #333;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 15px 20px;
    border-top: 1px solid #eee;
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: #666;
}
</style>

<script>
let accounts = [];
let accountToDelete = null;

// Load accounts
async function loadAccounts() {
    try {
        const response = await API.get('/accounts/');
        accounts = response.results || response;
        
        if (accounts.length === 0) {
            document.getElementById('accountsList').innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“Š</div>
                    <div>æš‚æ— è´¦æˆ·</div>
                    <div style="margin-top: 15px;">
                        <a href="/" class="btn btn-primary">åˆ›å»ºç¬¬ä¸€ä¸ªè´¦æˆ·</a>
                    </div>
                </div>
            `;
            return;
        }
        
        document.getElementById('accountsList').innerHTML = accounts.map(acc => {
            const modeColor = acc.mode === 'SIM' ? 'primary' : 'success';
            const modeText = acc.mode_display || (acc.mode === 'SIM' ? 'æ¨¡æ‹Ÿ' : 'çœŸå®');
            
            return `
                <div class="account-item">
                    <div class="account-header">
                        <div>
                            <span class="account-title">${acc.name || acc.market_type_display}</span>
                            <span class="badge badge-${modeColor}" style="margin-left: 10px;">${modeText}</span>
                        </div>
                        <div class="account-actions">
                            <a href="/accounts/${acc.id}/edit/" class="btn btn-secondary btn-sm">ç¼–è¾‘</a>
                            <a href="/accounts/${acc.id}/" class="btn btn-primary btn-sm">æŸ¥çœ‹è¯¦æƒ…</a>
                            <button class="btn btn-danger btn-sm" onclick="showDeleteModal(${acc.id}, '${acc.name || acc.market_type_display}')">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                    <div class="account-info">
                        <div class="account-info-item">
                            <div class="account-info-label">å¸‚åœºç±»å‹</div>
                            <div class="account-info-value">${acc.market_type_display}</div>
                        </div>
                        <div class="account-info-item">
                            <div class="account-info-label">å¸ç§</div>
                            <div class="account-info-value">${acc.currency || 'USD'}</div>
                        </div>
                        <div class="account-info-item">
                            <div class="account-info-label">èµ·å§‹èµ„é‡‘</div>
                            <div class="account-info-value">$${parseFloat(acc.start_cash).toLocaleString()}</div>
                        </div>
                        <div class="account-info-item">
                            <div class="account-info-label">åˆ›å»ºæ—¶é—´</div>
                            <div class="account-info-value">${new Date(acc.created_at).toLocaleDateString('zh-CN')}</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Failed to load accounts:', error);
        document.getElementById('accountsList').innerHTML = `
            <div class="empty-state">
                <div style="color: #dc3545;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>
            </div>
        `;
    }
}

// Show delete confirmation modal
function showDeleteModal(accountId, accountName) {
    accountToDelete = accountId;
    document.getElementById('deleteAccountName').textContent = accountName;
    document.getElementById('deleteModal').style.display = 'flex';
}

// Close delete modal
function closeDeleteModal() {
    accountToDelete = null;
    document.getElementById('deleteModal').style.display = 'none';
}

// Confirm delete
async function confirmDelete() {
    if (!accountToDelete) return;
    
    const btn = document.getElementById('confirmDeleteBtn');
    btn.disabled = true;
    btn.textContent = 'åˆ é™¤ä¸­...';
    
    try {
        await API.delete(`/accounts/${accountToDelete}/`);
        
        // Success
        closeDeleteModal();
        
        // Show success message
        const toast = document.createElement('div');
        toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000;';
        toast.textContent = 'âœ… è´¦æˆ·å·²åˆ é™¤';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
        
        // Reload list
        await loadAccounts();
        
    } catch (error) {
        console.error('Failed to delete account:', error);
        alert('åˆ é™¤å¤±è´¥ï¼š' + (error.message || 'è¯·é‡è¯•'));
    } finally {
        btn.disabled = false;
        btn.textContent = 'ç¡®è®¤åˆ é™¤';
    }
}

// åˆå§‹åŒ–
loadAccounts();
</script>

{% endblock %}
