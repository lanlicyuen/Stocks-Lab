{% extends 'base_new.html' %}

{% block title %}æ–°å»ºäº¤æ˜“ - æŠ•èµ„é¡¹ç›®æŠ«éœ²å¹³å°{% endblock %}

{% block content %}
<div class="desktop-nav">
    <a href="{% url 'dashboard' %}">é¦–é¡µ</a>
    <a href="javascript:history.back()">è¿”å›é¡¹ç›®</a>
    <a href="#">æ–°å»ºäº¤æ˜“</a>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">æ–°å»ºäº¤æ˜“è®°å½•</h2>
        <span id="projectBadge" class="badge badge-primary" style="display: none;"></span>
    </div>
    <div class="card-body">
        <form id="tradeForm">
            <!-- è´¦æˆ·é€‰æ‹© -->
            <div class="form-group" id="accountSelectGroup">
                <label>å¸‚åœºè´¦æˆ· <span style="color: red;">*</span></label>
                <select id="account" class="form-control" required>
                    <option value="">åŠ è½½ä¸­...</option>
                </select>
                <small class="form-text">é€‰æ‹©äº¤æ˜“è´¦æˆ·ï¼Œä¸åŒå¸‚åœºè´¦æˆ·èµ„é‡‘ç‹¬ç«‹è®¡ç®—</small>
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>æ ‡çš„ä»£ç  <span style="color: red;">*</span></label>
                    <input type="text" id="symbol" class="form-control" required placeholder="å¦‚ï¼šAAPL" style="text-transform: uppercase;">
                    <small class="form-text">è‡ªåŠ¨è½¬æ¢ä¸ºå¤§å†™</small>
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label>äº¤æ˜“æ–¹å‘ <span style="color: red;">*</span></label>
                    <select id="side" class="form-control" required>
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="BUY">ä¹°å…¥</option>
                        <option value="SELL">å–å‡º</option>
                    </select>
                </div>
            </div>
            
            <!-- è¯åˆ¸ä¿¡æ¯åŒºå— -->
            <div id="securityInfo" class="alert alert-info" style="display: none; margin-bottom: 15px;">
                <strong>æ ‡çš„ä¿¡æ¯ï¼š</strong>
                <div style="margin-top: 8px;">
                    <div><strong>èµ„äº§ç±»åˆ«ï¼š</strong><span id="securityAssetClass">-</span></div>
                    <div><strong>å…¬å¸/èµ„äº§åç§°ï¼š</strong><span id="securityName">-</span></div>
                    <div id="securitySectorRow" style="display: none;"><strong>è¡Œä¸šåˆ†ç±»ï¼š</strong><span id="securitySector">-</span></div>
                    <div id="securityExchangeRow" style="display: none;"><strong>äº¤æ˜“æ‰€ï¼š</strong><span id="securityExchange">-</span></div>
                </div>
            </div>
            
            <!-- è¡¥å……ä¿¡æ¯åŒºå—ï¼ˆè‚¡ç¥¨ä»£ç ä¸å­˜åœ¨æ—¶æ˜¾ç¤ºï¼‰ -->
            <div id="newSecurityForm" style="display: none; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin-top: 0; color: #856404;">ğŸ“ é¦–æ¬¡äº¤æ˜“æ­¤æ ‡çš„ï¼Œè¯·è¡¥å……ä¿¡æ¯</h4>
                
                <div class="form-group">
                    <label>èµ„äº§ç±»åˆ« <span style="color: red;">*</span></label>
                    <select id="securityAssetClassInput" class="form-control" required>
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="US_STOCK">ç¾è‚¡</option>
                        <option value="HK_STOCK">æ¸¯è‚¡</option>
                        <option value="CRYPTO">åŠ å¯†è´§å¸</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>å…¬å¸/èµ„äº§å…¨å <span style="color: red;">*</span></label>
                    <input type="text" id="securityNameInput" class="form-control" placeholder="ä¾‹å¦‚ï¼šApple Inc. æˆ– Bitcoin">
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label>è¡Œä¸šåˆ†ç±»ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="securitySectorInput" class="form-control" placeholder="ä¾‹å¦‚ï¼šç§‘æŠ€">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>äº¤æ˜“æ‰€ï¼ˆå¯é€‰ï¼‰</label>
                        <select id="securityExchangeInput" class="form-control">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="NASDAQ">NASDAQ</option>
                            <option value="NYSE">NYSE</option>
                            <option value="HKEX">HKEX</option>
                            <option value="BINANCE">Binance</option>
                            <option value="COINBASE">Coinbase</option>
                            <option value="OTHER">å…¶ä»–</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>ä»·æ ¼ <span style="color: red;">*</span></label>
                    <input type="number" id="price" class="form-control" step="0.01" required placeholder="æˆäº¤ä»·æ ¼" min="0">
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label>æ•°é‡ <span style="color: red;">*</span></label>
                    <input type="number" id="quantity" class="form-control" step="1" required placeholder="äº¤æ˜“æ•°é‡" min="1">
                </div>
                
                <div class="form-group" style="flex: 1;">
                    <label>æ‰‹ç»­è´¹</label>
                    <input type="number" id="fee" class="form-control" step="0.01" placeholder="0.00" min="0" value="0">
                    <small class="form-text">äº¤æ˜“æ‰‹ç»­è´¹ï¼ˆå¯é€‰ï¼‰</small>
                </div>
            </div>
            
            <div class="form-group">
                <label>äº¤æ˜“æ—¥æœŸ <span style="color: red;">*</span></label>
                <input type="datetime-local" id="executedAt" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label>äº¤æ˜“é€»è¾‘ <span style="color: red;">*</span></label>
                <textarea id="thesis" class="form-control" rows="8" required placeholder="è¯·è¯¦ç»†è¯´æ˜äº¤æ˜“é€»è¾‘ï¼Œæ”¯æŒ Markdown æ ¼å¼"></textarea>
                <small class="form-text">æ”¯æŒ Markdown æ ¼å¼ï¼Œå¦‚ **ç²—ä½“**ã€*æ–œä½“*ã€[é“¾æ¥](url)ã€åˆ—è¡¨ç­‰</small>
            </div>
            
            <div class="form-group">
                <label>é™„ä»¶ä¸Šä¼ </label>
                <input type="file" id="attachments" class="form-control" multiple accept="image/*,.pdf">
                <small class="form-text">æ”¯æŒå¤šå¼ å›¾ç‰‡æˆ–PDFï¼Œå•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡10MB</small>
            </div>
            
            <div id="attachmentPreview" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="window.history.back()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">æäº¤</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
let currentProjectId = null;
let currentSecurity = null;
let accounts = [];

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
    // Set default datetime to now
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('executedAt').value = now.toISOString().slice(0, 16);
    
    // Get projectId and display project info
    const urlParams = new URLSearchParams(window.location.search);
    currentProjectId = urlParams.get('project') || getCurrentProject();
    
    if (!currentProjectId) {
        showError('æœªé€‰æ‹©é¡¹ç›®ï¼Œè¯·è¿”å›é¦–é¡µé€‰æ‹©');
        document.getElementById('submitBtn').disabled = true;
        return;
    }
    
    // Load and display project info
    try {
        const project = await API.get(`/projects/${currentProjectId}/`);
        document.getElementById('projectBadge').textContent = `é¡¹ç›®: ${project.name}`;
        document.getElementById('projectBadge').style.display = 'inline-block';
        
        // Load market accounts
        await loadAccounts();
    } catch (error) {
        console.error('Failed to load project:', error);
    }
});

// Load market accounts
async function loadAccounts() {
    try {
        const response = await API.get(`/market-accounts/?project=${currentProjectId}`);
        accounts = response.results || response;
        
        const accountSelect = document.getElementById('account');
        
        if (accounts.length === 0) {
            accountSelect.innerHTML = '<option value="">æ­¤é¡¹ç›®æš‚æ— å¸‚åœºè´¦æˆ·ï¼Œè¯·å…ˆåˆ›å»º</option>';
            accountSelect.disabled = true;
            document.getElementById('submitBtn').disabled = true;
            showError('æ­¤é¡¹ç›®æš‚æ— å¸‚åœºè´¦æˆ·ï¼Œè¯·å…ˆåœ¨é¡¹ç›®é¡µé¢åˆ›å»ºå¸‚åœºè´¦æˆ·');
            return;
        }
        
        // å¦‚æœåªæœ‰ä¸€ä¸ªè´¦æˆ·ï¼Œè‡ªåŠ¨é€‰ä¸­å¹¶éšè—é€‰æ‹©å™¨
        if (accounts.length === 1) {
            accountSelect.innerHTML = `<option value="${accounts[0].id}" selected>${accounts[0].name} (${accounts[0].market_type_display})</option>`;
            document.getElementById('accountSelectGroup').style.display = 'none';
        } else {
            // å¤šä¸ªè´¦æˆ·ï¼Œæ˜¾ç¤ºé€‰æ‹©å™¨
            accountSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å¸‚åœºè´¦æˆ·</option>' +
                accounts.map(acc => 
                    `<option value="${acc.id}">${acc.name} (${acc.market_type_display} - ${acc.currency})</option>`
                ).join('');
        }
    } catch (error) {
        console.error('Failed to load accounts:', error);
        showError('åŠ è½½è´¦æˆ·å¤±è´¥');
    }
}

// Check symbol when input changes (with debounce)
let symbolCheckTimeout;
document.getElementById('symbol').addEventListener('input', function(e) {
    clearTimeout(symbolCheckTimeout);
    const symbol = e.target.value.trim().toUpperCase();
    
    if (symbol.length < 1) {
        hideSecurityInfo();
        return;
    }
    
    symbolCheckTimeout = setTimeout(() => {
        checkSecurity(symbol);
    }, 500);
});

async function checkSecurity(symbol) {
    if (!currentProjectId) return;
    
    try {
        const response = await API.get(`/securities/check-symbol/?project=${currentProjectId}&symbol=${symbol}`);
        
        if (response.exists) {
            // Security exists, show info
            currentSecurity = response.security;
            showExistingSecurity(response.security);
        } else {
            // Security not exists, show form to create
            currentSecurity = null;
            showNewSecurityForm();
        }
    } catch (error) {
        console.error('Failed to check security:', error);
    }
}

function showExistingSecurity(security) {
    document.getElementById('securityInfo').style.display = 'block';
    document.getElementById('newSecurityForm').style.display = 'none';
    
    // æ˜¾ç¤ºèµ„äº§ç±»åˆ«
    document.getElementById('securityAssetClass').textContent = security.asset_class_display || security.asset_class;
    
    // æ˜¾ç¤ºå…¬å¸/èµ„äº§åç§°
    document.getElementById('securityName').textContent = security.name;
    
    // æ˜¾ç¤ºè¡Œä¸šåˆ†ç±»ï¼ˆå¦‚æœ‰ï¼‰
    if (security.sector) {
        document.getElementById('securitySectorRow').style.display = 'block';
        document.getElementById('securitySector').textContent = security.sector;
    } else {
        document.getElementById('securitySectorRow').style.display = 'none';
    }
    
    // æ˜¾ç¤ºäº¤æ˜“æ‰€ï¼ˆå¦‚æœ‰ï¼‰
    if (security.exchange) {
        document.getElementById('securityExchangeRow').style.display = 'block';
        document.getElementById('securityExchange').textContent = security.exchange_display || security.exchange;
    } else {
        document.getElementById('securityExchangeRow').style.display = 'none';
    }
}

function showNewSecurityForm() {
    document.getElementById('securityInfo').style.display = 'none';
    document.getElementById('newSecurityForm').style.display = 'block';
}

function hideSecurityInfo() {
    document.getElementById('securityInfo').style.display = 'none';
    document.getElementById('newSecurityForm').style.display = 'none';
    currentSecurity = null;
}

// Preview attachments
document.getElementById('attachments').addEventListener('change', function(e) {
    const preview = document.getElementById('attachmentPreview');
    preview.innerHTML = '';
    
    Array.from(e.target.files).forEach(file => {
        if (file.size > 10 * 1024 * 1024) {
            showError(`æ–‡ä»¶ ${file.name} è¶…è¿‡10MBé™åˆ¶`);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '100px';
            img.style.height = '100px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '4px';
            img.style.border = '1px solid #ddd';
            preview.appendChild(img);
        };
        
        if (file.type.startsWith('image/')) {
            reader.readAsDataURL(file);
        } else {
            const div = document.createElement('div');
            div.textContent = file.name;
            div.style.padding = '10px';
            div.style.border = '1px solid #ddd';
            div.style.borderRadius = '4px';
            preview.appendChild(div);
        }
    });
});

// Form submission
document.getElementById('tradeForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'æäº¤ä¸­...';
    
    if (!currentProjectId) {
        showError('è¯·å…ˆé€‰æ‹©é¡¹ç›®');
        submitBtn.disabled = false;
        submitBtn.textContent = 'æäº¤';
        return;
    }
    
    const symbol = document.getElementById('symbol').value.trim().toUpperCase();
    const side = document.getElementById('side').value;
    const price = document.getElementById('price').value;
    const quantity = document.getElementById('quantity').value;
    const fee = document.getElementById('fee').value || '0';
    const executedAt = document.getElementById('executedAt').value;
    const thesis = document.getElementById('thesis').value.trim();
    const account = document.getElementById('account').value;
    
    if (!account) {
        showError('è¯·é€‰æ‹©å¸‚åœºè´¦æˆ·');
        submitBtn.disabled = false;
        submitBtn.textContent = 'æäº¤';
        return;
    }
    
    if (!symbol || !side || !price || !quantity || !executedAt || !thesis) {
        showError('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
        submitBtn.disabled = false;
        submitBtn.textContent = 'æäº¤';
        return;
    }
    
    // Prepare trade data
    const tradeData = {
        project: currentProjectId,
        account: parseInt(account),
        symbol: symbol,
        side: side,
        price: parseFloat(price),
        quantity: parseInt(quantity),
        fee: parseFloat(fee),
        executed_at: executedAt,
        thesis: thesis
    };
    
    // If security not exists, include security info
    if (!currentSecurity) {
        const securityAssetClass = document.getElementById('securityAssetClassInput').value.trim();
        const securityName = document.getElementById('securityNameInput').value.trim();
        const securitySector = document.getElementById('securitySectorInput').value.trim();
        const securityExchange = document.getElementById('securityExchangeInput').value.trim();
        
        if (!securityAssetClass || !securityName) {
            showError('è¯·å¡«å†™æ ‡çš„çš„èµ„äº§ç±»åˆ«å’Œåç§°');
            submitBtn.disabled = false;
            submitBtn.textContent = 'æäº¤';
            return;
        }
        
        tradeData.security_asset_class = securityAssetClass;
        tradeData.security_name = securityName;
        tradeData.security_sector = securitySector;
        tradeData.security_exchange = securityExchange;
    }
    
    try {
        // Create trade record
        const trade = await API.post('/trades/', tradeData);
        
        // Upload attachments if any
        const files = document.getElementById('attachments').files;
        if (files.length > 0) {
            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('owner_type', 'TRADE');
                formData.append('owner_id', trade.id);
                
                await API.upload('/attachments/', formData);
            }
        }
        
        showSuccess('äº¤æ˜“è®°å½•åˆ›å»ºæˆåŠŸï¼');
        setTimeout(() => {
            window.location.href = `/projects/${currentProjectId}/dashboard/`;
        }, 1000);
        
    } catch (error) {
        console.error('Create trade failed:', error);
        showError('åˆ›å»ºå¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
        submitBtn.disabled = false;
        submitBtn.textContent = 'æäº¤';
    }
});
</script>
{% endblock %}
