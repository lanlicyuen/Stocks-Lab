{% extends 'base_new.html' %}

{% block title %}äº¤æ˜“è®°å½• - æŠ•èµ„é¡¹ç›®æŠ«éœ²å¹³å°{% endblock %}

{% block content %}
<div class="desktop-nav">
    <a href="{% url 'dashboard' %}">é¦–é¡µ</a>
    <a href="javascript:history.back()">è¿”å›é¡¹ç›®</a>
    <a href="{% url 'balances' %}">æ—¥ç»“ä½™</a>
    <a href="{% url 'trades' %}" class="active">äº¤æ˜“è®°å½•</a>
</div>

<!-- Filter Section -->
<div class="card">
    <div class="card-body">
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label>äº¤æ˜“æ–¹å‘</label>
                <select id="sideFilter" class="form-control">
                    <option value="">å…¨éƒ¨</option>
                    <option value="BUY">ä¹°å…¥</option>
                    <option value="SELL">å–å‡º</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1;">
                <label>æ ‡çš„ä»£ç </label>
                <input type="text" id="symbolFilter" class="form-control" placeholder="å¦‚ï¼šAAPL">
            </div>
            <div class="form-group" style="flex: 0 0 auto; align-self: flex-end;">
                <button class="btn btn-primary" onclick="loadTrades()">ç­›é€‰</button>
            </div>
        </div>
    </div>
</div>

<!-- Trades List -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">äº¤æ˜“è®°å½•</h2>
        {% if user_role == 'ADMIN' %}
        <button class="btn btn-primary btn-sm" onclick="createTrade()">+ æ–°å»º</button>
        {% endif %}
    </div>
    <div class="card-body">
        <div id="tradesList">
            <div class="loading">
                <div class="spinner"></div>
                <div>åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
</div>

<!-- FAB for mobile -->
{% if user_role == 'ADMIN' %}
<button class="fab" onclick="createTrade()" title="æ–°å»ºäº¤æ˜“">
    +
</button>
{% endif %}

{% endblock %}

{% block extra_script %}
<script>
const userRole = '{{ user_role }}';

async function loadTrades() {
    // Try to get projectId from URL parameter first, then localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('project') || getCurrentProject();
    
    if (!projectId) {
        showError('è¯·å…ˆé€‰æ‹©é¡¹ç›®');
        document.getElementById('tradesList').innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ“</div>
                <div>è¯·å…ˆé€‰æ‹©é¡¹ç›®</div>
                <a href="/" class="btn btn-primary">è¿”å›é¦–é¡µ</a>
            </div>
        `;
        return;
    }
    
    const side = document.getElementById('sideFilter').value;
    const symbol = document.getElementById('symbolFilter').value;
    
    let url = `/trades/?project=${projectId}`;
    if (side) url += `&side=${side}`;
    if (symbol) url += `&symbol=${symbol}`;
    
    try {
        const trades = await API.get(url);
        renderTrades(trades);
    } catch (error) {
        console.error('Failed to load trades:', error);
        showError('åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
    }
}

function renderTrades(trades) {
    const container = document.getElementById('tradesList');
    
    if (trades.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ“ˆ</div>
                <div>æš‚æ— äº¤æ˜“è®°å½•</div>
            </div>
        `;
        return;
    }
    
    // Mobile cards
    container.innerHTML = trades.map(t => {
        const sideColor = t.side === 'BUY' ? '#28a745' : '#dc3545';
        const sideName = t.side === 'BUY' ? 'ä¹°å…¥' : 'å–å‡º';
        
        return `
            <div class="mobile-card" onclick="viewTrade(${t.id})">
                <div class="mobile-card-primary">
                    <span>${t.symbol}</span>
                    <span class="badge" style="background-color: ${sideColor};">${sideName}</span>
                </div>
                <div class="mobile-card-row">
                    <span class="mobile-card-label">ä»·æ ¼</span>
                    <span class="mobile-card-value">${formatCurrency(t.price)}</span>
                </div>
                <div class="mobile-card-row">
                    <span class="mobile-card-label">æ•°é‡</span>
                    <span class="mobile-card-value">${t.quantity}</span>
                </div>
                <div class="mobile-card-row">
                    <span class="mobile-card-label">æˆäº¤é‡‘é¢</span>
                    <span class="mobile-card-value" style="font-weight: bold;">
                        ${formatCurrency(t.total_amount)}
                    </span>
                </div>
                <div class="mobile-card-row">
                    <span class="mobile-card-label">äº¤æ˜“æ—¥æœŸ</span>
                    <span class="mobile-card-value">${formatDate(t.trade_date)}</span>
                </div>
            </div>
        `;
    }).join('');
    
    // Desktop table
    container.innerHTML += `
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>æ ‡çš„ä»£ç </th>
                        <th>äº¤æ˜“æ–¹å‘</th>
                        <th>ä»·æ ¼</th>
                        <th>æ•°é‡</th>
                        <th>æˆäº¤é‡‘é¢</th>
                        <th>äº¤æ˜“æ—¥æœŸ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${trades.map(t => {
                        const sideColor = t.side === 'BUY' ? '#28a745' : '#dc3545';
                        const sideName = t.side === 'BUY' ? 'ä¹°å…¥' : 'å–å‡º';
                        
                        return `
                            <tr>
                                <td><strong>${t.symbol}</strong></td>
                                <td>
                                    <span class="badge" style="background-color: ${sideColor};">
                                        ${sideName}
                                    </span>
                                </td>
                                <td>${formatCurrency(t.price)}</td>
                                <td>${t.quantity}</td>
                                <td style="font-weight: bold;">${formatCurrency(t.total_amount)}</td>
                                <td>${formatDate(t.trade_date)}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="viewTrade(${t.id})">æŸ¥çœ‹</button>
                                    ${userRole === 'ADMIN' ? `
                                    <button class="btn btn-danger btn-sm" onclick="deleteTrade(${t.id})">åˆ é™¤</button>
                                    ` : ''}
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function createTrade() {
    window.location.href = '/trades/create/';
}

function viewTrade(id) {
    window.location.href = `/trades/${id}/`;
}

async function deleteTrade(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡äº¤æ˜“è®°å½•å—ï¼Ÿ')) return;
    
    try {
        await API.delete(`/trades/${id}/`);
        showSuccess('åˆ é™¤æˆåŠŸï¼');
        loadTrades();
    } catch (error) {
        showError('åˆ é™¤å¤±è´¥ï¼š' + error.message);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadTrades();
});
</script>
{% endblock %}
