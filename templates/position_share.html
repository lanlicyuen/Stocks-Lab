{% extends 'base_new.html' %}

{% block title %}æŒä»“åˆ†äº« - æŠ•èµ„é¡¹ç›®æŠ«éœ²å¹³å°{% endblock %}

{% block content %}
<div class="desktop-nav">
    <a href="{% url 'dashboard' %}"><span>é¦–é¡µ</span></a>
    <a href="/accounts/"><span>è´¦æˆ·åˆ—è¡¨</span></a>
    <a href="/accounts/{{ account_id }}/"><span>è´¦æˆ·è¯¦æƒ…</span></a>
    <a href="#" class="active"><span>æŒä»“åˆ†äº«</span></a>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">ğŸ“¸ ç”Ÿæˆåˆ†äº«å›¾</h2>
        <button class="btn btn-primary" onclick="generateShareImage()">ç”Ÿæˆå›¾ç‰‡</button>
    </div>
    <div class="card-body">
        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div id="preview-container" style="max-width: 540px; margin: 0 auto;">
            <div id="share-canvas" style="display: none;">
                <!-- è¿™ä¸ªdivä¼šè¢«è½¬æ¢æˆå›¾ç‰‡ -->
            </div>
            <div id="preview-image"></div>
        </div>
    </div>
</div>

<style>
.share-image {
    width: 1080px;
    height: 1920px;
    position: relative;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    overflow: hidden;
}

.share-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #00C853 0%, #00E676 100%);
}

.share-bg.loss {
    background: linear-gradient(135deg, #F44336 0%, #FF5252 100%);
}

.watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-30deg);
    font-size: 120px;
    font-weight: 900;
    color: rgba(255, 255, 255, 0.08);
    white-space: nowrap;
    pointer-events: none;
    letter-spacing: 20px;
}

.share-header {
    position: absolute;
    top: 60px;
    left: 60px;
    display: flex;
    align-items: center;
    gap: 20px;
}

.platform-logo {
    font-size: 48px;
    font-weight: 700;
    color: white;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.pnl-section {
    position: absolute;
    top: 200px;
    left: 0;
    right: 0;
    text-align: center;
}

.pnl-label {
    display: inline-block;
    padding: 12px 40px;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 30px;
    font-size: 32px;
    color: white;
    margin-bottom: 30px;
    backdrop-filter: blur(10px);
}

.pnl-value {
    font-size: 160px;
    font-weight: 900;
    color: white;
    text-shadow: 0 4px 20px rgba(0,0,0,0.3);
    line-height: 1;
    margin-bottom: 20px;
}

.pnl-percent {
    font-size: 100px;
}

.mascot-container {
    position: absolute;
    top: 550px;
    left: 50%;
    transform: translateX(-50%);
    width: 800px;
    height: 800px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mascot-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3));
}

.mascot-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.placeholder-content {
    text-align: center;
    background: rgba(255, 255, 255, 0.15);
    border: 4px dashed rgba(255, 255, 255, 0.4);
    border-radius: 50%;
    width: 400px;
    height: 400px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.placeholder-icon {
    font-size: 180px;
    line-height: 1;
    margin-bottom: 20px;
    filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
}

.placeholder-text {
    font-size: 48px;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 4px;
}

.stock-info {
    position: absolute;
    bottom: 350px;
    left: 60px;
    right: 60px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 30px;
    padding: 50px;
    backdrop-filter: blur(20px);
}

.stock-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.stock-left {
    flex: 1;
}

.stock-code {
    font-size: 32px;
    color: #666;
    margin-bottom: 10px;
}

.stock-name {
    font-size: 56px;
    font-weight: 700;
    color: #333;
}

.stock-right {
    text-align: right;
}

.price-label {
    font-size: 28px;
    color: #999;
    margin-bottom: 8px;
}

.price-value {
    font-size: 64px;
    font-weight: 700;
    color: #333;
}

.avg-cost {
    margin-top: 30px;
}

.footer-info {
    position: absolute;
    bottom: 80px;
    left: 60px;
    right: 60px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.user-name {
    font-size: 36px;
    color: white;
    font-weight: 500;
}

.share-date {
    font-size: 32px;
    color: rgba(255, 255, 255, 0.9);
}

.qrcode-container {
    position: absolute;
    bottom: 60px;
    right: 60px;
    width: 150px;
    height: 150px;
    background: white;
    border-radius: 15px;
    padding: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
}

.qrcode-container img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const accountId = {{ account_id }};
let accountData = null;
let positionData = null;

// åŠ è½½è´¦æˆ·æ•°æ®
async function loadAccountData() {
    try {
        accountData = await API.get(`/accounts/${accountId}/`);
        console.log('Account data:', accountData);
    } catch (error) {
        console.error('Failed to load account:', error);
        showError('åŠ è½½è´¦æˆ·æ•°æ®å¤±è´¥');
    }
}

// ç”Ÿæˆåˆ†äº«å›¾
async function generateShareImage() {
    if (!accountData) {
        await loadAccountData();
    }
    
    if (!accountData) {
        showError('æ— æ³•åŠ è½½è´¦æˆ·æ•°æ®');
        return;
    }
    
    // è·å–æŒä»“æ•°æ®
    const positions = accountData.positions || [];
    if (positions.length === 0) {
        showError('æš‚æ— æŒä»“æ•°æ®');
        return;
    }
    
    // ä½¿ç”¨ç¬¬ä¸€ä¸ªæŒä»“
    positionData = positions[0];
    
    // è®¡ç®—ç›ˆäº
    const currentPrice = positionData.long_avg_cost || 0; // è¿™é‡Œåº”è¯¥æ˜¯å®æ—¶ä»·æ ¼ï¼Œæš‚ç”¨æˆæœ¬ä»·
    const avgCost = positionData.long_avg_cost || 0;
    const pnlPercent = avgCost > 0 ? ((currentPrice - avgCost) / avgCost * 100) : 0;
    const isProfit = pnlPercent >= 0;
    
    // åˆ›å»ºåˆ†äº«å›¾HTML
    const shareHTML = `
        <div class="share-image">
            <div class="share-bg ${isProfit ? '' : 'loss'}"></div>
            
            <!-- èƒŒæ™¯æ°´å° -->
            <div class="watermark">1PLABS PRO</div>
            
            <!-- å¹³å°Logo -->
            <div class="share-header">
                <div class="platform-logo">ğŸ“Š Stocks-Lab</div>
            </div>
            
            <!-- ç›ˆäºç™¾åˆ†æ¯” -->
            <div class="pnl-section">
                <div class="pnl-label">% Unrealized P/L</div>
                <div class="pnl-value">
                    ${isProfit ? '+' : ''}${pnlPercent.toFixed(2)}<span class="pnl-percent">%</span>
                </div>
            </div>
            
            <!-- å¡é€šäººç‰© -->
            <div class="mascot-container">
                <img src="/static/images/mascot.png" alt="Mascot" class="mascot-image" 
                     onerror="this.style.display='none'; this.parentElement.querySelector('.mascot-placeholder').style.display='flex';">
                <div class="mascot-placeholder" style="display: none;">
                    <div class="placeholder-content">
                        <div class="placeholder-icon">ğŸ‘‘</div>
                        <div class="placeholder-text">Mascot</div>
                    </div>
                </div>
            </div>
            
            <!-- è‚¡ç¥¨ä¿¡æ¯ -->
            <div class="stock-info">
                <div class="stock-row">
                    <div class="stock-left">
                        <div class="stock-code">${positionData.symbol || '00100'}</div>
                        <div class="stock-name">${positionData.name || 'Stock Name'}</div>
                    </div>
                    <div class="stock-right">
                        <div class="price-label">Price</div>
                        <div class="price-value">${currentPrice.toFixed(3)}</div>
                    </div>
                </div>
                <div class="stock-row avg-cost">
                    <div class="stock-left"></div>
                    <div class="stock-right">
                        <div class="price-label">Avg Cost</div>
                        <div class="price-value">${avgCost.toFixed(3)}</div>
                    </div>
                </div>
            </div>
            
            <!-- åº•éƒ¨ä¿¡æ¯ -->
            <div class="footer-info">
                <div class="user-name">${accountData.name || 'User'}</div>
                <div class="share-date">${new Date().toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})} ${new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</div>
            </div>
            
            <!-- äºŒç»´ç ä½ç½®é¢„ç•™ -->
            <!-- <div class="qrcode-container">
                <img src="/path/to/qrcode.png" alt="QR Code" style="width: 150px; height: 150px;">
            </div> -->
        </div>
    `;
    
    // æ¸²æŸ“åˆ°éšè—çš„canvas
    const canvas = document.getElementById('share-canvas');
    canvas.innerHTML = shareHTML;
    canvas.style.display = 'block';
    
    // ç­‰å¾…å›¾ç‰‡åŠ è½½
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // ä½¿ç”¨html2canvasç”Ÿæˆå›¾ç‰‡
    try {
        const canvasElement = await html2canvas(canvas, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: null,
            width: 1080,
            height: 1920
        });
        
        // éšè—canvas
        canvas.style.display = 'none';
        
        // æ˜¾ç¤ºé¢„è§ˆ
        const preview = document.getElementById('preview-image');
        preview.innerHTML = `
            <img src="${canvasElement.toDataURL('image/png')}" 
                 style="width: 100%; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="downloadImage('${canvasElement.toDataURL('image/png')}')">
                    ğŸ’¾ ä¸‹è½½å›¾ç‰‡
                </button>
            </div>
        `;
        
        showSuccess('å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼');
        
    } catch (error) {
        console.error('Failed to generate image:', error);
        showError('ç”Ÿæˆå›¾ç‰‡å¤±è´¥: ' + error.message);
    }
}

// ä¸‹è½½å›¾ç‰‡
function downloadImage(dataUrl) {
    const link = document.createElement('a');
    link.download = `æŒä»“åˆ†äº«-${new Date().getTime()}.png`;
    link.href = dataUrl;
    link.click();
}

// Toastæç¤º
function showError(message) {
    const toast = document.createElement('div');
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000;';
    toast.textContent = 'âŒ ' + message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function showSuccess(message) {
    const toast = document.createElement('div');
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000;';
    toast.textContent = 'âœ… ' + message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    loadAccountData();
});
</script>

{% endblock %}
