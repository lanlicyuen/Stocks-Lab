{% extends 'base_new.html' %}

{% block title %}Dashboard - æŠ•èµ„é¡¹ç›®æŠ«éœ²å¹³å°{% endblock %}

{% block content %}
<div class="desktop-nav" style="display: none;">
    <a href="{% url 'dashboard' %}" class="active">é¦–é¡µ</a>
    <a href="{% url 'dashboard' %}">è´¦æˆ·åˆ—è¡¨</a>
</div>

<!-- Stats Overview -->
<div class="stats-grid" id="statsGrid">
    <div class="stat-card">
        <div class="stat-label">é¡¹ç›®æ•°</div>
        <div class="stat-value" id="projectCount">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">æ€»æŠ•èµ„</div>
        <div class="stat-value" id="totalInvestment">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">ä»Šæ—¥ç›ˆäº</div>
        <div class="stat-value" id="todayPnL">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">æ€»æ”¶ç›Šç‡</div>
        <div class="stat-value" id="totalReturn">-</div>
    </div>
</div>

<!-- My Projects -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">æˆ‘çš„é¡¹ç›®</h2>
        {% if user_role == 'ADMIN' %}
        <a href="#" class="btn btn-primary btn-sm" onclick="showCreateProjectModal(); return false;">
            + æ–°å»ºé¡¹ç›®
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        <div id="projectsList">
            <div class="loading">
                <div class="spinner"></div>
                <div>åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_script %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
const userRole = '{{ user_role }}';

// Load dashboard data
async function loadDashboard() {
    try {
        const response = await API.get('/projects/');
        const projects = response.results || response; // å¤„ç†åˆ†é¡µå’Œéåˆ†é¡µæƒ…å†µ
        
        // Update stats
        document.getElementById('projectCount').textContent = Array.isArray(projects) ? projects.length : 0;
        
        // Calculate total investment
        let totalInv = 0;
        for (const project of projects) {
            try {
                const contributions = await API.get(`/contributions/?project=${project.id}`);
                contributions.forEach(c => totalInv += parseFloat(c.amount));
            } catch (e) {
                console.warn('Failed to load contributions for project', project.id);
            }
        }
        document.getElementById('totalInvestment').textContent = formatCurrency(totalInv);
        
        // Mock data for now
        document.getElementById('todayPnL').textContent = '+Â¥1,250';
        document.getElementById('totalReturn').textContent = '+12.5%';
        
        // Render projects list
        renderProjects(projects);
        
    } catch (error) {
        console.error('Failed to load dashboard:', error);
        document.getElementById('projectsList').innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">âš ï¸</div>
                <div>åŠ è½½å¤±è´¥</div>
                <button class="btn btn-primary" onclick="loadDashboard()">é‡è¯•</button>
            </div>
        `;
    }
}

function renderProjects(projects) {
    const container = document.getElementById('projectsList');
    
    if (projects.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ“</div>
                <div>æš‚æ— é¡¹ç›®</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = projects.map(project => `
        <div class="mobile-card" onclick="selectProject(${project.id})">
            <div class="mobile-card-primary">${project.name}</div>
            ${project.description ? `
            <div class="mobile-card-row">
                <span class="mobile-card-label">æè¿°</span>
                <span class="mobile-card-value">${project.description}</span>
            </div>
            ` : ''}
            <div class="mobile-card-row">
                <span class="mobile-card-label">æˆå‘˜</span>
                <span class="mobile-card-value">${project.member_count} äºº</span>
            </div>
            <div class="mobile-card-row">
                <span class="mobile-card-label">æˆ‘çš„è§’è‰²</span>
                <span class="badge ${project.my_role === 'ADMIN' ? 'badge-danger' : 'badge-primary'}">
                    ${project.my_role === 'ADMIN' ? 'ç®¡ç†å‘˜' : 'è§‚å¯Ÿè€…'}
                </span>
            </div>
            <div class="mobile-card-row">
                <span class="mobile-card-label">åˆ›å»ºæ—¶é—´</span>
                <span class="mobile-card-value">${new Date(project.created_at).toLocaleDateString('zh-CN')}</span>
            </div>
        </div>
    `).join('');
    
    // Add desktop table
    container.innerHTML += `
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>é¡¹ç›®åç§°</th>
                        <th>æˆ‘çš„è§’è‰²</th>
                        <th>æˆå‘˜æ•°</th>
                        <th>åˆ›å»ºè€…</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${projects.map(p => `
                        <tr>
                            <td><strong>${p.name}</strong></td>
                            <td>
                                <span class="badge ${p.my_role === 'ADMIN' ? 'badge-danger' : 'badge-primary'}">
                                    ${p.my_role === 'ADMIN' ? 'ç®¡ç†å‘˜' : 'è§‚å¯Ÿè€…'}
                                </span>
                            </td>
                            <td>${p.member_count}</td>
                            <td>${p.created_by.username}</td>
                            <td>${new Date(p.created_at).toLocaleDateString('zh-CN')}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="selectProject(${p.id})">é€‰æ‹©</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function showCreateProjectModal() {
    const name = prompt('è¯·è¾“å…¥é¡¹ç›®åç§°ï¼š');
    if (!name) return;
    
    const description = prompt('è¯·è¾“å…¥é¡¹ç›®æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š');
    
    createProject(name, description || '');
}

function selectProject(projectId) {
    setCurrentProject(projectId);
    window.location.href = `/projects/${projectId}/dashboard/`;
}

async function createProject(name, description) {
    try {
        await API.post('/projects/', { name, description });
        showSuccess('é¡¹ç›®åˆ›å»ºæˆåŠŸï¼');
        loadDashboard();
    } catch (error) {
        showError('åˆ›å»ºå¤±è´¥ï¼š' + error.message);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadDashboard();
});
</script>
{% endblock %}
