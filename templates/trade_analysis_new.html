{% extends 'base_new.html' %}

{% block title %}åˆ†ç±»å¤ç›˜ - æŠ•èµ„é¡¹ç›®æŠ«éœ²å¹³å°{% endblock %}

{% block content %}
<div class="desktop-nav">
    <a href="{% url 'dashboard' %}">é¦–é¡µ</a>
    <a href="javascript:history.back()">è¿”å›é¡¹ç›®</a>
    <a href="#">åˆ†ç±»å¤ç›˜</a>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">äº¤æ˜“åˆ†ç±»å¤ç›˜ä¸ç»Ÿè®¡</h2>
        <span id="projectBadge" class="badge badge-primary" style="display: none;"></span>
    </div>
    <div class="card-body">
        <!-- ç­›é€‰æ¡ä»¶ -->
        <div class="filter-section" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div class="form-row" style="margin-bottom: 10px;">
                <div class="form-group" style="flex: 1; margin-right: 10px;">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="fromDate" class="form-control">
                </div>
                <div class="form-group" style="flex: 1; margin-right: 10px;">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="toDate" class="form-control">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 1; margin-right: 10px;">
                    <label>èµ„äº§ç±»åˆ«</label>
                    <select id="assetClassFilter" class="form-control">
                        <option value="">å…¨éƒ¨ç±»åˆ«</option>
                        <option value="US_STOCK">ç¾è‚¡</option>
                        <option value="HK_STOCK">æ¸¯è‚¡</option>
                        <option value="CRYPTO">åŠ å¯†è´§å¸</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1; margin-right: 10px;">
                    <label>è¡Œä¸šç­›é€‰</label>
                    <select id="sectorFilter" class="form-control">
                        <option value="">å…¨éƒ¨è¡Œä¸š</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>&nbsp;</label>
                    <button onclick="applyFilter()" class="btn btn-primary" style="width: 100%;">æŸ¥è¯¢</button>
                </div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div id="overviewStats" style="display: none; margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px;">ğŸ“Š ç»Ÿè®¡æ¦‚è§ˆ</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">æ€»äº¤æ˜“æ¬¡æ•°</div>
                    <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);" id="totalTrades">0</div>
                </div>
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">ä¹°å…¥æ€»é¢</div>
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="totalBuy">Â¥0</div>
                </div>
                <div style="background: #ffebee; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">å–å‡ºæ€»é¢</div>
                    <div style="font-size: 24px; font-weight: bold; color: #dc3545;" id="totalSell">Â¥0</div>
                </div>
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">å‡€æµé‡</div>
                    <div style="font-size: 24px; font-weight: bold;" id="netFlow">Â¥0</div>
                </div>
            </div>
        </div>
        
        <!-- æŒ‰è¡Œä¸šæ±‡æ€» -->
        <div id="sectorSummary" style="display: none; margin-bottom: 30px;">
            <h3 style="margin-bottom: 15px;">ğŸ“ˆ è¡Œä¸šæ±‡æ€»</h3>
            <div id="sectorTable" class="table-container">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
        </div>
        
        <!-- æŒ‰è‚¡ç¥¨è¯¦ç»† -->
        <div id="securityDetail" style="display: none;">
            <h3 style="margin-bottom: 15px;">ğŸ“‘ è‚¡ç¥¨æ˜ç»†</h3>
            <div id="securityTable" class="table-container">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
        </div>
        
        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="empty-state">
            <div class="empty-icon">ğŸ“Š</div>
            <div>æš‚æ— äº¤æ˜“æ•°æ®</div>
            <small>è¯·é€‰æ‹©æ—¶é—´èŒƒå›´åç‚¹å‡»æŸ¥è¯¢</small>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
let currentProjectId = null;
let currentData = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
    // Get projectId
    const urlParams = new URLSearchParams(window.location.search);
    currentProjectId = urlParams.get('project') || getCurrentProject();
    
    if (!currentProjectId) {
        showError('æœªé€‰æ‹©é¡¹ç›®ï¼Œè¯·è¿”å›é¦–é¡µé€‰æ‹©');
        return;
    }
    
    // Load and display project info
    try {
        const project = await API.get(`/projects/${currentProjectId}/`);
        document.getElementById('projectBadge').textContent = `é¡¹ç›®: ${project.name}`;
        document.getElementById('projectBadge').style.display = 'inline-block';
    } catch (error) {
        console.error('Failed to load project:', error);
    }
    
    // Load sectors for filter
    await loadSectors();
    
    // Set default date range (last 30 days)
    const toDate = new Date();
    const fromDate = new Date();
    fromDate.setDate(fromDate.getDate() - 30);
    
    document.getElementById('toDate').value = toDate.toISOString().split('T')[0];
    document.getElementById('fromDate').value = fromDate.toISOString().split('T')[0];
    
    // Auto load data
    applyFilter();
});

async function loadSectors() {
    if (!currentProjectId) return;
    
    try {
        const response = await API.get(`/securities/?project=${currentProjectId}`);
        const securities = response.results || response;
        
        // Extract unique sectors
        const sectors = [...new Set(securities.map(s => s.sector).filter(s => s))];
        
        const select = document.getElementById('sectorFilter');
        sectors.forEach(sector => {
            const option = document.createElement('option');
            option.value = sector;
            option.textContent = sector;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load sectors:', error);
    }
}

async function applyFilter() {
    if (!currentProjectId) return;
    
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    const assetClass = document.getElementById('assetClassFilter').value;
    const sector = document.getElementById('sectorFilter').value;
    
    // Build query params
    let queryParams = `project=${currentProjectId}`;
    if (fromDate) queryParams += `&from=${fromDate}T00:00:00`;
    if (toDate) queryParams += `&to=${toDate}T23:59:59`;
    if (assetClass) queryParams += `&asset_class=${encodeURIComponent(assetClass)}`;
    if (sector) queryParams += `&sector=${encodeURIComponent(sector)}`;
    
    try {
        const data = await API.get(`/securities/trade-summary/?${queryParams}`);
        currentData = data;
        
        if (data.by_security.length === 0) {
            showEmptyState();
        } else {
            hideEmptyState();
            renderOverview(data);
            renderSectorSummary(data.by_sector);
            renderSecurityDetail(data.by_security);
        }
    } catch (error) {
        console.error('Failed to load trade summary:', error);
        showError('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥');
    }
}

function showEmptyState() {
    document.getElementById('emptyState').style.display = 'block';
    document.getElementById('overviewStats').style.display = 'none';
    document.getElementById('sectorSummary').style.display = 'none';
    document.getElementById('securityDetail').style.display = 'none';
}

function hideEmptyState() {
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('overviewStats').style.display = 'block';
    document.getElementById('sectorSummary').style.display = 'block';
    document.getElementById('securityDetail').style.display = 'block';
}

function renderOverview(data) {
    let totalTrades = 0;
    let totalBuy = 0;
    let totalSell = 0;
    
    data.by_security.forEach(item => {
        totalTrades += item.trade_count;
        totalBuy += item.buy_total;
        totalSell += item.sell_total;
    });
    
    const netFlow = totalSell - totalBuy;
    
    document.getElementById('totalTrades').textContent = totalTrades;
    document.getElementById('totalBuy').textContent = formatCurrency(totalBuy);
    document.getElementById('totalSell').textContent = formatCurrency(totalSell);
    document.getElementById('netFlow').textContent = formatCurrency(netFlow);
    document.getElementById('netFlow').style.color = netFlow >= 0 ? '#28a745' : '#dc3545';
}

function renderSectorSummary(sectors) {
    if (!sectors || sectors.length === 0) {
        document.getElementById('sectorSummary').style.display = 'none';
        return;
    }
    
    const html = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>è¡Œä¸š</th>
                    <th>æ ‡çš„æ•°</th>
                    <th>äº¤æ˜“æ¬¡æ•°</th>
                    <th>ä¹°å…¥æ€»é¢</th>
                    <th>å–å‡ºæ€»é¢</th>
                    <th>å‡€æµé‡</th>
                </tr>
            </thead>
            <tbody>
                ${sectors.map(sector => `
                    <tr>
                        <td><strong>${sector.sector}</strong></td>
                        <td>${sector.symbol_count}</td>
                        <td>${sector.trade_count}</td>
                        <td style="color: #28a745;">${formatCurrency(sector.buy_total)}</td>
                        <td style="color: #dc3545;">${formatCurrency(sector.sell_total)}</td>
                        <td style="color: ${sector.net_flow >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">
                            ${formatCurrency(sector.net_flow)}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    document.getElementById('sectorTable').innerHTML = html;
}

function renderSecurityDetail(securities) {
    if (!securities || securities.length === 0) {
        document.getElementById('securityDetail').style.display = 'none';
        return;
    }
    
    const html = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>èµ„äº§ç±»åˆ«</th>
                    <th>ä»£ç </th>
                    <th>åç§°</th>
                    <th>è¡Œä¸š</th>
                    <th>äº¤æ˜“æ¬¡æ•°</th>
                    <th>ä¹°å…¥æ•°é‡</th>
                    <th>å–å‡ºæ•°é‡</th>
                    <th>ä¹°å…¥æ€»é¢</th>
                    <th>å–å‡ºæ€»é¢</th>
                    <th>å‡€æµé‡</th>
                </tr>
            </thead>
            <tbody>
                ${securities.map(item => `
                    <tr>
                        <td><span class="badge badge-${getAssetClassBadge(item.asset_class)}">${item.asset_class_display || item.asset_class}</span></td>
                        <td><strong>${item.symbol}</strong></td>
                        <td>${item.name}</td>
                        <td>${item.sector || '-'}</td>
                        <td>${item.trade_count}</td>
                        <td>${item.buy_quantity}</td>
                        <td>${item.sell_quantity}</td>
                        <td style="color: #28a745;">${formatCurrency(item.buy_total)}</td>
                        <td style="color: #dc3545;">${formatCurrency(item.sell_total)}</td>
                        <td style="color: ${item.net_flow >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">
                            ${formatCurrency(item.net_flow)}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    document.getElementById('securityTable').innerHTML = html;
}

function getAssetClassBadge(assetClass) {
    const badges = {
        'US_STOCK': 'primary',
        'HK_STOCK': 'success',
        'CRYPTO': 'warning'
    };
    return badges[assetClass] || 'secondary';
}
</script>

<style>
.filter-section {
    animation: slideDown 0.3s ease-out;
}

.table-container {
    overflow-x: auto;
    margin-top: 10px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
}

.data-table thead {
    background: var(--primary-color);
    color: white;
}

.data-table th,
.data-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}

.data-table th {
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.data-table tbody tr:hover {
    background: #f8f9fa;
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

@media (max-width: 768px) {
    .data-table {
        font-size: 12px;
    }
    
    .data-table th,
    .data-table td {
        padding: 8px 6px;
    }
}
</style>
{% endblock %}
