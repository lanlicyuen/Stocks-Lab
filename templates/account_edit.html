{% extends 'base_new.html' %}

{% block title %}ç¼–è¾‘è´¦æˆ· - æŠ•èµ„é¡¹ç›®æŠ«éœ²å¹³å°{% endblock %}

{% block content %}
<div class="desktop-nav">
    <a href="{% url 'dashboard' %}"><span id="nav-home">é¦–é¡µ</span></a>
    <a href="/accounts/"><span id="nav-account-list">è´¦æˆ·åˆ—è¡¨</span></a>
    <a href="#" class="active"><span id="nav-edit-account">ç¼–è¾‘è´¦æˆ·</span></a>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">âœï¸ ç¼–è¾‘è´¦æˆ·</h2>
    </div>
    <div class="card-body">
        <form id="editAccountForm" onsubmit="handleSubmit(event)">
            <div class="form-group">
                <label for="name" class="required">è´¦æˆ·åç§°</label>
                <input type="text" id="name" class="form-control" required 
                       placeholder="ä¾‹å¦‚: æˆ‘çš„ç¾è‚¡è´¦æˆ·">
                <small class="form-text">è‡ªå®šä¹‰è´¦æˆ·åç§°,æ–¹ä¾¿è¯†åˆ«</small>
            </div>

            <div class="form-group">
                <label>å¸‚åœºç±»å‹</label>
                <input type="text" id="market_type_display" class="form-control" readonly>
                <small class="form-text">å¸‚åœºç±»å‹åˆ›å»ºåä¸å¯ä¿®æ”¹</small>
            </div>

            <div class="form-group">
                <label>è´¦å·æ¨¡å¼</label>
                <input type="text" id="mode_display" class="form-control" readonly>
                <small class="form-text">è´¦å·æ¨¡å¼åˆ›å»ºåä¸å¯ä¿®æ”¹</small>
            </div>

            <div class="form-group">
                <label>å¸ç§</label>
                <input type="text" id="currency_display" class="form-control" readonly>
                <small class="form-text">å¸ç§åˆ›å»ºåä¸å¯ä¿®æ”¹</small>
            </div>

            <div class="form-group">
                <label>èµ·å§‹èµ„é‡‘</label>
                <input type="text" id="start_cash_display" class="form-control" readonly>
                <small class="form-text">èµ·å§‹èµ„é‡‘åˆ›å»ºåä¸å¯ä¿®æ”¹</small>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="goBack()">
                    å–æ¶ˆ
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    ğŸ’¾ ä¿å­˜ä¿®æ”¹
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-group label.required::after {
    content: ' *';
    color: #dc3545;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    box-sizing: border-box;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
}

.form-control:read-only {
    background-color: #f5f5f5;
    cursor: not-allowed;
}

.form-text {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #666;
}

.form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-primary:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: #666;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
let accountId = null;
let accountData = null;

// Get account ID from URL
function getAccountIdFromUrl() {
    const pathParts = window.location.pathname.split('/');
    return pathParts[2]; // /accounts/{id}/edit/
}

// Go back
function goBack() {
    const accountId = getAccountIdFromUrl();
    window.location.href = `/accounts/${accountId}/`;
}

// Load account data
async function loadAccountData() {
    accountId = getAccountIdFromUrl();
    
    if (!accountId) {
        showError('æ— æ•ˆçš„è´¦æˆ·ID');
        setTimeout(() => window.history.back(), 2000);
        return;
    }
    
    try {
        accountData = await API.get(`/accounts/${accountId}/`);
        
        // Fill form
        document.getElementById('name').value = accountData.name || '';
        document.getElementById('market_type_display').value = accountData.market_type_display || '';
        document.getElementById('mode_display').value = accountData.mode_display || '';
        document.getElementById('currency_display').value = accountData.currency_display || accountData.currency || '';
        document.getElementById('start_cash_display').value = parseFloat(accountData.start_cash).toLocaleString();
        
    } catch (error) {
        console.error('Failed to load account:', error);
        showError('åŠ è½½è´¦æˆ·ä¿¡æ¯å¤±è´¥: ' + (error.message || 'è¯·é‡è¯•'));
        setTimeout(() => window.history.back(), 2000);
    }
}

// Handle form submit
async function handleSubmit(event) {
    event.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'ä¿å­˜ä¸­...';
    
    try {
        const name = document.getElementById('name').value.trim();
        
        if (!name) {
            showError('è¯·è¾“å…¥è´¦æˆ·åç§°');
            return;
        }
        
        // Update account
        await API.patch(`/accounts/${accountId}/`, {
            name: name
        });
        
        // Success
        showSuccess('è´¦æˆ·ä¿¡æ¯å·²æ›´æ–°');
        
        // Redirect back to account detail
        setTimeout(() => {
            window.location.href = `/accounts/${accountId}/`;
        }, 1000);
        
    } catch (error) {
        console.error('Failed to update account:', error);
        showError('æ›´æ–°å¤±è´¥: ' + (error.message || 'è¯·é‡è¯•'));
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
    }
}

// Show error message
function showError(message) {
    const toast = document.createElement('div');
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000;';
    toast.textContent = 'âŒ ' + message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Show success message
function showSuccess(message) {
    const toast = document.createElement('div');
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000;';
    toast.textContent = 'âœ… ' + message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadAccountData();
});
</script>

{% endblock %}
