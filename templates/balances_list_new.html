{% extends 'base_new.html' %}

{% block title %}æ—¥ç»“ä½™åˆ—è¡¨ - æŠ•èµ„é¡¹ç›®æŠ«éœ²å¹³å°{% endblock %}

{% block content %}
<div class="desktop-nav">
    <a href="{% url 'dashboard' %}">é¦–é¡µ</a>
    <a href="javascript:history.back()">è¿”å›é¡¹ç›®</a>
    <a href="{% url 'balances' %}" class="active">æ—¥ç»“ä½™</a>
    <a href="{% url 'trades' %}">äº¤æ˜“è®°å½•</a>
</div>

<!-- Filter Section -->
<div class="card">
    <div class="card-body">
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label>å¼€å§‹æ—¥æœŸ</label>
                <input type="date" id="fromDate" class="form-control">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>ç»“æŸæ—¥æœŸ</label>
                <input type="date" id="toDate" class="form-control">
            </div>
            <div class="form-group" style="flex: 0 0 auto; align-self: flex-end;">
                <button class="btn btn-primary" onclick="loadBalances()">ç­›é€‰</button>
            </div>
        </div>
    </div>
</div>

<!-- Balances List -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">æ—¥ç»“ä½™è®°å½•</h2>
        {% if user_role == 'ADMIN' %}
        <button class="btn btn-primary btn-sm" onclick="showCreateModal()">+ æ–°å»º</button>
        {% endif %}
    </div>
    <div class="card-body">
        <div id="balancesList">
            <div class="loading">
                <div class="spinner"></div>
                <div>åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
</div>

<!-- FAB for mobile -->
{% if user_role == 'ADMIN' %}
<button class="fab" onclick="showCreateModal()" title="æ–°å»ºæ—¥ç»“ä½™">
    +
</button>
{% endif %}

{% endblock %}

{% block extra_script %}
<script>
const userRole = '{{ user_role }}';

async function loadBalances() {
    // Try to get projectId from URL parameter first, then localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('project') || getCurrentProject();
    
    if (!projectId) {
        showError('è¯·å…ˆé€‰æ‹©é¡¹ç›®');
        document.getElementById('balancesList').innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ“</div>
                <div>è¯·å…ˆé€‰æ‹©é¡¹ç›®</div>
                <a href="/" class="btn btn-primary">è¿”å›é¦–é¡µ</a>
            </div>
        `;
        return;
    }
    
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    
    let url = `/balances/?project=${projectId}`;
    if (fromDate) url += `&date_after=${fromDate}`;
    if (toDate) url += `&date_before=${toDate}`;
    
    try {
        const balances = await API.get(url);
        renderBalances(balances);
    } catch (error) {
        console.error('Failed to load balances:', error);
        showError('åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
    }
}

function renderBalances(balances) {
    const container = document.getElementById('balancesList');
    
    if (balances.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ“Š</div>
                <div>æš‚æ— æ•°æ®</div>
            </div>
        `;
        return;
    }
    
    // Mobile cards
    container.innerHTML = balances.map(b => `
        <div class="mobile-card" onclick="viewBalance(${b.id})">
            <div class="mobile-card-primary">${formatDate(b.date)}</div>
            <div class="mobile-card-row">
                <span class="mobile-card-label">è´¦æˆ·ä½™é¢</span>
                <span class="mobile-card-value" style="font-weight: bold; color: var(--primary-color);">
                    ${formatCurrency(b.amount)}
                </span>
            </div>
            ${b.note ? `
            <div class="mobile-card-row">
                <span class="mobile-card-label">å¤‡æ³¨</span>
                <span class="mobile-card-value">${b.note}</span>
            </div>
            ` : ''}
            <div class="mobile-card-row">
                <span class="mobile-card-label">è®°å½•äºº</span>
                <span class="mobile-card-value">${b.recorded_by.username}</span>
            </div>
        </div>
    `).join('');
    
    // Desktop table
    container.innerHTML += `
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>è´¦æˆ·ä½™é¢</th>
                        <th>å¤‡æ³¨</th>
                        <th>è®°å½•äºº</th>
                        <th>è®°å½•æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${balances.map(b => `
                        <tr>
                            <td><strong>${formatDate(b.date)}</strong></td>
                            <td style="font-weight: bold; color: var(--primary-color);">
                                ${formatCurrency(b.amount)}
                            </td>
                            <td>${b.note || '-'}</td>
                            <td>${b.recorded_by.username}</td>
                            <td>${formatDateTime(b.created_at)}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="viewBalance(${b.id})">æŸ¥çœ‹</button>
                                ${userRole === 'ADMIN' ? `
                                <button class="btn btn-danger btn-sm" onclick="deleteBalance(${b.id})">åˆ é™¤</button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function showCreateModal() {
    window.location.href = '/balances/create/';
}

function viewBalance(id) {
    showInfo(`æŸ¥çœ‹è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­... (ID: ${id})`);
}

async function deleteBalance(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
    
    try {
        await API.delete(`/balances/${id}/`);
        showSuccess('åˆ é™¤æˆåŠŸï¼');
        loadBalances();
    } catch (error) {
        showError('åˆ é™¤å¤±è´¥ï¼š' + error.message);
    }
}

// Set default date range (last 30 days)
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('toDate').value = today.toISOString().split('T')[0];
    document.getElementById('fromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    
    loadBalances();
});
</script>
{% endblock %}
