{% extends 'base_new.html' %}

{% block title %}äº¤æ˜“åˆ†äº« - æŠ•èµ„é¡¹ç›®æŠ«éœ²å¹³å°{% endblock %}

{% block content %}
<div class="desktop-nav">
    <a href="{% url 'dashboard' %}"><span>é¦–é¡µ</span></a>
    <a href="/accounts/"><span>è´¦æˆ·åˆ—è¡¨</span></a>
    <a href="/accounts/{{ account_id }}/"><span>è´¦æˆ·è¯¦æƒ…</span></a>
    <a href="#" class="active"><span>äº¤æ˜“åˆ†äº«</span></a>
</div>

<div class="card">
    <div class="button-group">
        <button class="btn" onclick="generateTradeImage()">ç”Ÿæˆå›¾ç‰‡</button>
        <button class="btn btn-secondary" onclick="generateTradeNote()">å¯¼å‡ºäº¤æ˜“ç¬”è®°</button>
        <button class="btn btn-primary" id="downloadBtn" onclick="downloadImage()" style="display: none;">ä¸‹è½½å›¾ç‰‡</button>
        <button class="btn btn-primary" id="downloadNoteBtn" onclick="downloadNote()" style="display: none;">ä¸‹è½½ç¬”è®°</button>
    </div>
    <div class="card-body">
        <!-- äº¤æ˜“åˆ—è¡¨ -->
        <div id="trade-list" style="margin-bottom: 20px;">
            <label style="font-weight: 600; margin-bottom: 15px; display: block;">å·²å®Œæˆçš„æ’®åˆäº¤æ˜“ (<span id="trade-count">0</span>):</label>
            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">åªæ˜¾ç¤ºå¼€ä»“å’Œå¹³ä»“éƒ½å·²å®Œæˆçš„å®Œæ•´äº¤æ˜“å¯¹</div>
            <div id="trade-items" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                <div style="padding: 20px; text-align: center; color: #666;">
                    åŠ è½½ä¸­...
                </div>
            </div>
        </div>
        
        <!-- äº¤æ˜“è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div id="trade-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>äº¤æ˜“è¯¦æƒ…</h3>
                    <span class="close" onclick="closeTradeModal()">&times;</span>
                </div>
                <div class="modal-body" id="trade-details">
                    <!-- äº¤æ˜“è¯¦æƒ…å†…å®¹ -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeTradeModal()">å…³é—­</button>
                    <button class="btn btn-primary" onclick="generateTradeImageFromModal()">ç”Ÿæˆåˆ†äº«å›¾</button>
                    <button class="btn btn-secondary" onclick="generateTradeNoteFromModal()">å¯¼å‡ºç¬”è®°</button>
                </div>
            </div>
        </div>
        
        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div id="preview-container" style="max-width: 540px; margin: 0 auto;">
            <div id="share-canvas" style="display: none;">
                <!-- è¿™ä¸ªdivä¼šè¢«è½¬æ¢æˆå›¾ç‰‡ -->
            </div>
            <div id="preview-image"></div>
        </div>
    </div>
</div>

<style>
.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.share-image {
    width: 1080px;
    height: 1920px;
    position: relative;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    overflow: hidden;
}

.share-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #00C853 0%, #00E676 100%);
}

.share-bg.loss {
    background: linear-gradient(135deg, #F44336 0%, #FF5252 100%);
}

.watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-30deg);
    font-size: 120px;
    font-weight: 900;
    color: rgba(255, 255, 255, 0.08);
    white-space: nowrap;
    pointer-events: none;
    letter-spacing: 20px;
}

.share-header {
    position: absolute;
    top: 60px;
    left: 60px;
}

.platform-logo {
    font-size: 48px;
    font-weight: 700;
    color: white;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.pnl-section {
    position: absolute;
    top: 200px;
    left: 0;
    right: 0;
    text-align: center;
}

.pnl-label {
    display: inline-block;
    padding: 12px 40px;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 30px;
    font-size: 32px;
    color: white;
    margin-bottom: 30px;
    backdrop-filter: blur(10px);
}

.pnl-value {
    font-size: 160px;
    font-weight: 900;
    color: white;
    text-shadow: 0 4px 20px rgba(0,0,0,0.3);
    line-height: 1;
    margin-bottom: 20px;
}

.pnl-currency {
    font-size: 80px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.95);
}

.mascot-container {
    position: absolute;
    top: 550px;
    left: 50%;
    transform: translateX(-50%);
    width: 800px;
    height: 800px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mascot-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3));
}

.mascot-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.placeholder-content {
    text-align: center;
    background: rgba(255, 255, 255, 0.15);
    border: 4px dashed rgba(255, 255, 255, 0.4);
    border-radius: 50%;
    width: 400px;
    height: 400px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.placeholder-icon {
    font-size: 180px;
    line-height: 1;
    margin-bottom: 20px;
    filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
}

.placeholder-text {
    font-size: 48px;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 4px;
}

.trade-info {
    position: absolute;
    bottom: 220px;
    left: 40px;
    right: 40px;
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 24px;
    padding: 25px 40px;
    backdrop-filter: blur(15px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    transform: scale(0.95);
    transform-origin: center bottom;
}

.trade-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.trade-row:last-child {
    margin-bottom: 0;
}

.trade-left {
    flex: 1;
}

.trade-label {
    font-size: 36px;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 10px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    font-weight: 500;
}

.trade-value {
    font-size: 60px;
    font-weight: 700;
    color: white;
    text-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.trade-code {
    font-size: 40px;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 12px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    font-weight: 600;
}

.trade-name {
    font-size: 68px;
    font-weight: 700;
    color: white;
    text-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.footer-info-new {
    position: absolute;
    bottom: 60px;
    left: 60px;
    right: 60px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}

.user-info-left {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.user-name {
    font-size: 40px;
    color: white;
    font-weight: 600;
    text-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.share-date {
    font-size: 28px;
    color: rgba(255, 255, 255, 0.85);
    text-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.qrcode-container {
    width: 150px;
    height: 150px;
    background: white;
    border-radius: 15px;
    padding: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.qrcode-container img {
    width: 130px !important;
    height: 130px !important;
    display: block;
}

.qrcode-container canvas {
    width: 130px !important;
    height: 130px !important;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-secondary {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #e083eb 0%, #e5475c 100%);
}

/* äº¤æ˜“åˆ—è¡¨æ ·å¼ */
.trade-item {
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.trade-item:hover {
    background-color: #f0f0f0;
}

.trade-item:last-child {
    border-bottom: none;
}

.trade-item-info {
    flex: 1;
}

.trade-symbol {
    font-weight: bold;
    font-size: 16px;
    color: #333;
}

.trade-name {
    font-size: 14px;
    color: #666;
    margin-top: 2px;
}

.trade-meta {
    font-size: 12px;
    color: #999;
    margin-top: 4px;
}

.trade-pnl {
    text-align: right;
    font-weight: bold;
    font-size: 14px;
}

.pnl-profit {
    color: #28a745;
}

.pnl-loss {
    color: #dc3545;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    width: 90%;
    max-width: 600px;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: #333;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #000;
}

.modal-body {
    padding: 20px;
    max-height: 400px;
    overflow-y: auto;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #ddd;
    text-align: right;
}

.modal-footer .btn {
    margin-left: 10px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs2@0.0.2/qrcode.min.js"></script>

<script>
const accountId = {{ account_id }};
let trades = [];
let selectedTrade = null;

// åŠ è½½äº¤æ˜“è®°å½•
async function loadTrades() {
    try {
        const response = await API.get(`/trades/?account=${accountId}`);
        
        // å¤„ç†å“åº”æ ¼å¼
        if (Array.isArray(response)) {
            trades = response;
        } else if (response && Array.isArray(response.results)) {
            trades = response.results;
        } else {
            trades = [];
        }
        
        // åªæ˜¾ç¤ºå·²å®Œæˆçš„äº¤æ˜“
        trades = trades.filter(t => t.status === 'FILLED');
        
        console.log('Loaded trades:', trades);
        renderTradeList();
        
    } catch (error) {
        console.error('Failed to load trades:', error);
        showError('åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥');
    }
}

// æ¸²æŸ“äº¤æ˜“åˆ—è¡¨
function renderTradeList() {
    const container = document.getElementById('trade-items');
    const countElement = document.getElementById('trade-count');
    
    // æ‰¾å‡ºæ‰€æœ‰å®Œæ•´çš„æ’®åˆäº¤æ˜“ï¼ˆå¼€ä»“+å¹³ä»“ï¼‰
    const completedTrades = findCompletedTrades();
    
    countElement.textContent = completedTrades.length;
    
    if (completedTrades.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">æš‚æ— å·²å®Œæˆçš„æ’®åˆäº¤æ˜“</div>';
        return;
    }
    
    const tradeItems = completedTrades.map(completedTrade => {
        const { openTrade, closeTrade, pnl } = completedTrade;
        const date = new Date(closeTrade.traded_at).toLocaleDateString('zh-CN');
        const time = new Date(closeTrade.traded_at).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
        const symbol = closeTrade.security_info?.symbol || closeTrade.security?.symbol || closeTrade.security_symbol || 'N/A';
        const name = closeTrade.security_info?.name || closeTrade.security?.name || closeTrade.security_name || '';
        
        const pnlDisplay = pnl >= 0 ? `+${pnl.toFixed(2)}` : pnl.toFixed(2);
        const pnlClass = pnl >= 0 ? 'pnl-profit' : 'pnl-loss';
        
        // è®¡ç®—æŒä»“å¤©æ•°
        const holdDays = Math.floor((new Date(closeTrade.traded_at) - new Date(openTrade.traded_at)) / (1000 * 60 * 60 * 24));
        
        return `
            <div class="trade-item" onclick="showCompletedTradeDetails(${openTrade.id}, ${closeTrade.id})">
                <div class="trade-item-info">
                    <div class="trade-symbol">${symbol}</div>
                    <div class="trade-name">${name}</div>
                    <div class="trade-meta">${date} ${time} Â· å®Œæˆæ’®åˆ Â· æŒä»“${holdDays}å¤© Â· æ•°é‡: ${closeTrade.quantity}</div>
                </div>
                <div class="trade-pnl ${pnlClass}">${pnlDisplay} æ¸¯å…ƒ</div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = tradeItems;
}

// æ‰¾å‡ºæ‰€æœ‰å®Œæ•´çš„æ’®åˆäº¤æ˜“
function findCompletedTrades() {
    const completedTrades = [];
    const processedTrades = new Set();
    
    // éå†æ‰€æœ‰å¹³ä»“äº¤æ˜“
    trades.forEach(trade => {
        if (trade.action === 'CLOSE_LONG' || trade.action === 'CLOSE_SHORT') {
            if (processedTrades.has(trade.id)) return;
            
            // æŸ¥æ‰¾å¯¹åº”çš„å¼€ä»“äº¤æ˜“
            const openAction = trade.action === 'CLOSE_LONG' ? 'OPEN_LONG' : 'OPEN_SHORT';
            const openTrade = trades.find(t => 
                t.security_info?.symbol === trade.security_info?.symbol &&
                t.action === openAction &&
                parseFloat(t.quantity) === parseFloat(trade.quantity) &&
                new Date(t.traded_at) < new Date(trade.traded_at) &&
                !processedTrades.has(t.id)
            );
            
            if (openTrade) {
                // è®¡ç®—ç›ˆäº
                let pnl = parseFloat(trade.realized_pnl || 0);
                if (pnl === 0) {
                    const openPrice = parseFloat(openTrade.price);
                    const closePrice = parseFloat(trade.price);
                    const quantity = parseFloat(trade.quantity);
                    
                    if (trade.action === 'CLOSE_LONG') {
                        pnl = (closePrice - openPrice) * quantity - parseFloat(trade.fee || 0) - parseFloat(openTrade.fee || 0);
                    } else {
                        pnl = (openPrice - closePrice) * quantity - parseFloat(trade.fee || 0) - parseFloat(openTrade.fee || 0);
                    }
                }
                
                completedTrades.push({
                    openTrade,
                    closeTrade: trade,
                    pnl
                });
                
                processedTrades.add(openTrade.id);
                processedTrades.add(trade.id);
            }
        }
    });
    
    // æŒ‰å¹³ä»“æ—¶é—´æ’åº
    return completedTrades.sort((a, b) => new Date(b.closeTrade.traded_at) - new Date(a.closeTrade.traded_at));
}

// æ˜¾ç¤ºæ’®åˆäº¤æ˜“è¯¦æƒ…
function showCompletedTradeDetails(openTradeId, closeTradeId) {
    const openTrade = trades.find(t => t.id == openTradeId);
    const closeTrade = trades.find(t => t.id == closeTradeId);
    
    if (!openTrade || !closeTrade) {
        showError('æœªæ‰¾åˆ°äº¤æ˜“è®°å½•');
        return;
    }
    
    // è®¾ç½®é€‰ä¸­çš„äº¤æ˜“ä¸ºå¹³ä»“äº¤æ˜“ï¼ˆç”¨äºç”Ÿæˆå›¾ç‰‡å’Œç¬”è®°ï¼‰
    selectedTrade = closeTrade;
    
    // è®¡ç®—ç›ˆäº
    let pnl = parseFloat(closeTrade.realized_pnl || 0);
    if (pnl === 0) {
        const openPrice = parseFloat(openTrade.price);
        const closePrice = parseFloat(closeTrade.price);
        const quantity = parseFloat(closeTrade.quantity);
        
        if (closeTrade.action === 'CLOSE_LONG') {
            pnl = (closePrice - openPrice) * quantity - parseFloat(closeTrade.fee || 0) - parseFloat(openTrade.fee || 0);
        } else {
            pnl = (openPrice - closePrice) * quantity - parseFloat(closeTrade.fee || 0) - parseFloat(openTrade.fee || 0);
        }
    }
    
    const isProfit = pnl >= 0;
    const symbol = closeTrade.security_info?.symbol || 'æœªçŸ¥ä»£ç ';
    const name = closeTrade.security_info?.name || 'è‚¡ç¥¨åç§°';
    const holdDays = Math.floor((new Date(closeTrade.traded_at) - new Date(openTrade.traded_at)) / (1000 * 60 * 60 * 24));
    
    // æ„å»ºè¯¦æƒ…HTML
    const detailsHTML = `
        <div style="line-height: 1.6;">
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0; color: #333;">æ’®åˆäº¤æ˜“æ¦‚è§ˆ</h4>
                <div style="margin-bottom: 8px;"><strong>è‚¡ç¥¨ä»£ç ï¼š</strong>${symbol}</div>
                <div style="margin-bottom: 8px;"><strong>è‚¡ç¥¨åç§°ï¼š</strong>${name}</div>
                <div style="margin-bottom: 8px;"><strong>æŒä»“å¤©æ•°ï¼š</strong>${holdDays} å¤©</div>
                <div style="padding: 10px; background: ${isProfit ? '#d4edda' : '#f8d7da'}; border-radius: 5px;">
                    <strong style="color: ${isProfit ? '#155724' : '#721c24'};">æ€»ç›ˆäºï¼š</strong>
                    <span style="color: ${isProfit ? '#155724' : '#721c24'}; font-weight: bold; font-size: 20px;">
                        ${isProfit ? '+' : ''}${pnl.toFixed(2)} æ¸¯å…ƒ
                    </span>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px;">ğŸ“ˆ å¼€ä»“ä¿¡æ¯</h4>
                <div style="margin-bottom: 8px;"><strong>äº¤æ˜“ç±»å‹ï¼š</strong>${getActionDisplay(openTrade.action)}</div>
                <div style="margin-bottom: 8px;"><strong>å¼€ä»“ä»·æ ¼ï¼š</strong>${parseFloat(openTrade.price).toFixed(3)} æ¸¯å…ƒ</div>
                <div style="margin-bottom: 8px;"><strong>äº¤æ˜“æ•°é‡ï¼š</strong>${openTrade.quantity}</div>
                <div style="margin-bottom: 8px;"><strong>äº¤æ˜“é‡‘é¢ï¼š</strong>${(parseFloat(openTrade.price) * parseFloat(openTrade.quantity)).toFixed(2)} æ¸¯å…ƒ</div>
                <div style="margin-bottom: 8px;"><strong>æ‰‹ç»­è´¹ï¼š</strong>${openTrade.fee || 0} æ¸¯å…ƒ</div>
                <div style="margin-bottom: 8px;"><strong>å¼€ä»“æ—¶é—´ï¼š</strong>${new Date(openTrade.traded_at).toLocaleString('zh-CN')}</div>
                <div style="margin-bottom: 8px;"><strong>å¼€ä»“å¤‡æ³¨ï¼š</strong>${openTrade.notes || 'æ— '}</div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 15px 0; color: #333; border-bottom: 2px solid #dc3545; padding-bottom: 5px;">ğŸ“‰ å¹³ä»“ä¿¡æ¯</h4>
                <div style="margin-bottom: 8px;"><strong>äº¤æ˜“ç±»å‹ï¼š</strong>${getActionDisplay(closeTrade.action)}</div>
                <div style="margin-bottom: 8px;"><strong>å¹³ä»“ä»·æ ¼ï¼š</strong>${parseFloat(closeTrade.price).toFixed(3)} æ¸¯å…ƒ</div>
                <div style="margin-bottom: 8px;"><strong>äº¤æ˜“æ•°é‡ï¼š</strong>${closeTrade.quantity}</div>
                <div style="margin-bottom: 8px;"><strong>äº¤æ˜“é‡‘é¢ï¼š</strong>${(parseFloat(closeTrade.price) * parseFloat(closeTrade.quantity)).toFixed(2)} æ¸¯å…ƒ</div>
                <div style="margin-bottom: 8px;"><strong>æ‰‹ç»­è´¹ï¼š</strong>${closeTrade.fee || 0} æ¸¯å…ƒ</div>
                <div style="margin-bottom: 8px;"><strong>å¹³ä»“æ—¶é—´ï¼š</strong>${new Date(closeTrade.traded_at).toLocaleString('zh-CN')}</div>
                <div style="margin-bottom: 8px;"><strong>å¹³ä»“å¤‡æ³¨ï¼š</strong>${closeTrade.notes || 'æ— '}</div>
            </div>
        </div>
    `;
    
    document.getElementById('trade-details').innerHTML = detailsHTML;
    document.getElementById('trade-modal').style.display = 'block';
}

// æ˜¾ç¤ºå•ç¬”äº¤æ˜“è¯¦æƒ…ï¼ˆä¿ç•™åŸå‡½æ•°ä»¥å¤‡ä½¿ç”¨ï¼‰
function showTradeDetails(tradeId) {
    selectedTrade = trades.find(t => t.id == tradeId);
    if (!selectedTrade) {
        showError('æœªæ‰¾åˆ°é€‰ä¸­çš„äº¤æ˜“');
        return;
    }
    
    // è®¡ç®—ç›ˆäº
    let pnl = parseFloat(selectedTrade.realized_pnl || 0);
    const isClose = selectedTrade.action === 'CLOSE_LONG' || selectedTrade.action === 'CLOSE_SHORT';
    
    if (isClose && pnl === 0) {
        const relatedTrade = trades.find(t => 
            t.security_info?.symbol === selectedTrade.security_info?.symbol &&
            t.action === (selectedTrade.action === 'CLOSE_LONG' ? 'OPEN_LONG' : 'OPEN_SHORT') &&
            parseFloat(t.quantity) === parseFloat(selectedTrade.quantity) &&
            new Date(t.traded_at) < new Date(selectedTrade.traded_at)
        );
        
        if (relatedTrade) {
            const openPrice = parseFloat(relatedTrade.price);
            const closePrice = parseFloat(selectedTrade.price);
            const quantity = parseFloat(selectedTrade.quantity);
            
            if (selectedTrade.action === 'CLOSE_LONG') {
                pnl = (closePrice - openPrice) * quantity - parseFloat(selectedTrade.fee || 0) - parseFloat(relatedTrade.fee || 0);
            } else {
                pnl = (openPrice - closePrice) * quantity - parseFloat(selectedTrade.fee || 0) - parseFloat(relatedTrade.fee || 0);
            }
        }
    }
    
    const isProfit = pnl >= 0;
    const symbol = selectedTrade.security_info?.symbol || 'æœªçŸ¥ä»£ç ';
    const name = selectedTrade.security_info?.name || 'è‚¡ç¥¨åç§°';
    
    // æ„å»ºè¯¦æƒ…HTML
    const detailsHTML = `
        <div style="line-height: 1.6;">
            <div style="margin-bottom: 15px;">
                <strong>è‚¡ç¥¨ä»£ç ï¼š</strong>${symbol}
            </div>
            <div style="margin-bottom: 15px;">
                <strong>è‚¡ç¥¨åç§°ï¼š</strong>${name}
            </div>
            <div style="margin-bottom: 15px;">
                <strong>äº¤æ˜“ç±»å‹ï¼š</strong>${getActionDisplay(selectedTrade.action)}
            </div>
            <div style="margin-bottom: 15px;">
                <strong>äº¤æ˜“ä»·æ ¼ï¼š</strong>${parseFloat(selectedTrade.price).toFixed(3)} æ¸¯å…ƒ
            </div>
            <div style="margin-bottom: 15px;">
                <strong>äº¤æ˜“æ•°é‡ï¼š</strong>${selectedTrade.quantity}
            </div>
            <div style="margin-bottom: 15px;">
                <strong>äº¤æ˜“é‡‘é¢ï¼š</strong>${(parseFloat(selectedTrade.price) * parseFloat(selectedTrade.quantity)).toFixed(2)} æ¸¯å…ƒ
            </div>
            <div style="margin-bottom: 15px;">
                <strong>æ‰‹ç»­è´¹ï¼š</strong>${selectedTrade.fee || 0} æ¸¯å…ƒ
            </div>
            <div style="margin-bottom: 15px;">
                <strong>äº¤æ˜“æ—¶é—´ï¼š</strong>${new Date(selectedTrade.traded_at).toLocaleString('zh-CN')}
            </div>
            <div style="margin-bottom: 15px;">
                <strong>å¤‡æ³¨ï¼š</strong>${selectedTrade.notes || 'æ— '}
            </div>
            <div style="margin-bottom: 15px; padding: 10px; background: ${isProfit ? '#d4edda' : '#f8d7da'}; border-radius: 5px;">
                <strong style="color: ${isProfit ? '#155724' : '#721c24'};">ç›ˆäºé‡‘é¢ï¼š</strong>
                <span style="color: ${isProfit ? '#155724' : '#721c24'}; font-weight: bold; font-size: 18px;">
                    ${isProfit ? '+' : ''}${pnl.toFixed(2)} æ¸¯å…ƒ
                </span>
            </div>
        </div>
    `;
    
    document.getElementById('trade-details').innerHTML = detailsHTML;
    document.getElementById('trade-modal').style.display = 'block';
}

// å…³é—­æ¨¡æ€æ¡†
function closeTradeModal() {
    document.getElementById('trade-modal').style.display = 'none';
}

// ä»æ¨¡æ€æ¡†ç”Ÿæˆå›¾ç‰‡
function generateTradeImageFromModal() {
    closeTradeModal();
    generateTradeImage();
}

// ä»æ¨¡æ€æ¡†å¯¼å‡ºç¬”è®°
function generateTradeNoteFromModal() {
    closeTradeModal();
    generateTradeNote();
}

// è·å–æ“ä½œæ˜¾ç¤ºæ–‡æœ¬
function getActionDisplay(action) {
    const actions = {
        'OPEN_LONG': 'å¼€å¤š',
        'CLOSE_LONG': 'å¹³å¤š',
        'OPEN_SHORT': 'å¼€ç©º',
        'CLOSE_SHORT': 'å¹³ç©º'
    };
    return actions[action] || action;
}

// ç”Ÿæˆäº¤æ˜“åˆ†äº«å›¾
async function generateTradeImage() {
    if (!selectedTrade) {
        showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäº¤æ˜“');
        return;
    }
    
    // æ‰“å°å®Œæ•´çš„äº¤æ˜“æ•°æ®ä»¥ä¾¿è°ƒè¯•
    console.log('Selected trade full data:', selectedTrade);
    
    // è·å–è‚¡ç¥¨ä¿¡æ¯ - ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå security_info
    const symbol = selectedTrade.security_info?.symbol || 
                   selectedTrade.security?.symbol || 
                   selectedTrade.security_symbol || 
                   selectedTrade.symbol || 
                   'æœªçŸ¥ä»£ç ';
    const name = selectedTrade.security_info?.name || 
                 selectedTrade.security?.name || 
                 selectedTrade.security_name || 
                 selectedTrade.name || 
                 'è‚¡ç¥¨åç§°';
    
    // è®¡ç®—ç›ˆäº
    let pnl = parseFloat(selectedTrade.realized_pnl || 0);
    
    // å¦‚æœæ˜¯å¹³ä»“æ“ä½œä¸”ç›ˆäºä¸º0ï¼Œå°è¯•è‡ªåŠ¨è®¡ç®—
    if ((selectedTrade.action === 'CLOSE_LONG' || selectedTrade.action === 'CLOSE_SHORT') && pnl === 0) {
        // æŸ¥æ‰¾å¯¹åº”çš„å¼€ä»“äº¤æ˜“
        const openAction = selectedTrade.action === 'CLOSE_LONG' ? 'OPEN_LONG' : 'OPEN_SHORT';
        const openTrade = trades.find(t => 
            t.security_info?.symbol === selectedTrade.security_info?.symbol &&
            t.action === openAction &&
            parseFloat(t.quantity) === parseFloat(selectedTrade.quantity) &&
            new Date(t.traded_at) < new Date(selectedTrade.traded_at)
        );
        
        if (openTrade) {
            const openPrice = parseFloat(openTrade.price);
            const closePrice = parseFloat(selectedTrade.price);
            const quantity = parseFloat(selectedTrade.quantity);
            
            // è®¡ç®—ç›ˆäºï¼š(å¹³ä»“ä»· - å¼€ä»“ä»·) Ã— æ•°é‡ - æ‰‹ç»­è´¹
            if (selectedTrade.action === 'CLOSE_LONG') {
                pnl = (closePrice - openPrice) * quantity - parseFloat(selectedTrade.fee || 0) - parseFloat(openTrade.fee || 0);
            } else {
                pnl = (openPrice - closePrice) * quantity - parseFloat(selectedTrade.fee || 0) - parseFloat(openTrade.fee || 0);
            }
            
            console.log('Auto calculated P&L:', {
                openPrice,
                closePrice,
                quantity,
                calculatedPnl: pnl,
                openTrade: openTrade
            });
        }
    }
    
    const totalCost = parseFloat(selectedTrade.quantity) * parseFloat(selectedTrade.price) + parseFloat(selectedTrade.fee || 0);
    const pnlPercent = totalCost > 0 ? (pnl / totalCost * 100) : 0;
    const isProfit = pnl >= 0;
    
    // æ ¼å¼åŒ–ç›ˆäºé‡‘é¢ - æ€»æ˜¯æ˜¾ç¤º
    const pnlDisplay = `${isProfit ? '+' : ''}${pnl.toFixed(2)}`;
    
    console.log('Trade info:', {
        symbol, 
        name, 
        pnl, 
        pnlPercent, 
        isProfit, 
        totalCost, 
        pnlDisplay,
        realized_pnl: selectedTrade.realized_pnl,
        action: selectedTrade.action
    });
    
    // åˆ›å»ºåˆ†äº«å›¾HTML
    const shareHTML = `
        <div class="share-image">
            <div class="share-bg ${isProfit ? '' : 'loss'}"></div>
            
            <!-- èƒŒæ™¯æ°´å° -->
            <div class="watermark">1PLABS PRO</div>
            
            <!-- å¹³å°Logo -->
            <div class="share-header">
                <div class="platform-logo">ğŸ“Š Stocks-Lab</div>
            </div>
            
            <!-- ç›ˆäºç™¾åˆ†æ¯” -->
            <div class="pnl-section">
                <div class="pnl-label">${isProfit ? 'å·²å®ç°ç›ˆåˆ©' : 'å·²å®ç°äºæŸ'}</div>
                <div class="pnl-value">
                    ${isProfit ? '+' : ''}${pnl.toFixed(2)} <span class="pnl-currency">æ¸¯å…ƒ</span>
                </div>
                <div style="font-size: 56px; color: rgba(255,255,255,0.9); margin-top: 20px;">
                    ${isProfit ? '+' : ''}${pnlPercent.toFixed(2)}%
                </div>
            </div>
            
            <!-- å¡é€šäººç‰© -->
            <div class="mascot-container">
                <img src="/static/images/mascot.png" alt="Mascot" class="mascot-image" 
                     onerror="this.style.display='none'; this.parentElement.querySelector('.mascot-placeholder').style.display='flex';">
                <div class="mascot-placeholder" style="display: none;">
                    <div class="placeholder-content">
                        <div class="placeholder-icon">${isProfit ? 'ğŸ‰' : 'ğŸ’ª'}</div>
                        <div class="placeholder-text">${isProfit ? 'Profit' : 'Loss'}</div>
                    </div>
                </div>
            </div>
            
            <!-- äº¤æ˜“ä¿¡æ¯ -->
            <div class="trade-info">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 40px;">
                    <!-- è‚¡ç¥¨ä»£ç å’Œåç§° -->
                    <div style="flex: 0 0 auto; text-align: center;">
                        <div class="trade-code">${symbol}</div>
                        <div class="trade-name">${name}</div>
                    </div>
                    
                    <!-- æ“ä½œå’Œç›ˆäº -->
                    <div style="flex: 0 0 auto; text-align: center;">
                        <div class="trade-label" style="margin-bottom: 8px;">æ“ä½œ</div>
                        <div class="trade-value" style="display: flex; align-items: center; gap: 15px;">
                            <span>${getActionDisplay(selectedTrade.action)}</span>
                            <span style="color: ${isProfit ? '#FF3B30' : '#333333'}; font-size: 52px; font-weight: 800; text-shadow: 0 2px 8px rgba(0,0,0,0.3);">${pnlDisplay}</span>
                        </div>
                    </div>
                    
                    <!-- å¹³å‡ä»· -->
                    <div style="flex: 0 0 auto; text-align: center;">
                        <div class="trade-label" style="margin-bottom: 8px;">å¹³å‡ä»·</div>
                        <div class="trade-value">${parseFloat(selectedTrade.price).toFixed(3)}</div>
                    </div>
                </div>
            </div>
            
            <!-- åº•éƒ¨ä¿¡æ¯ -->
            <div class="footer-info-new">
                <div class="user-info-left">
                    <div class="user-name">${selectedTrade.account_name || 'User'}</div>
                    <div class="share-date">${new Date(selectedTrade.traded_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})} ${new Date(selectedTrade.traded_at).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}</div>
                </div>
                <div class="qrcode-container" id="qrcode-${selectedTrade.id}"></div>
            </div>
        </div>
    `;
    
    // æ¸²æŸ“åˆ°éšè—çš„canvas
    const canvas = document.getElementById('share-canvas');
    canvas.innerHTML = shareHTML;
    canvas.style.display = 'block';
    
    // ç”ŸæˆäºŒç»´ç 
    const qrContainer = canvas.querySelector(`#qrcode-${selectedTrade.id}`);
    if (qrContainer && typeof QRCode !== 'undefined') {
        // æ¸…ç©ºå®¹å™¨
        qrContainer.innerHTML = '';
        
        // ç”Ÿæˆåˆ†äº«URL
        const shareUrl = `${window.location.origin}/accounts/${accountId}/trades/${selectedTrade.id}/`;
        
        // ä½¿ç”¨QRCodeåº“ç”ŸæˆäºŒç»´ç 
        new QRCode(qrContainer, {
            text: shareUrl,
            width: 130,
            height: 130,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.M
        });
    }
    
    // ç­‰å¾…å›¾ç‰‡å’ŒäºŒç»´ç åŠ è½½
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // ä½¿ç”¨html2canvasç”Ÿæˆå›¾ç‰‡
    try {
        const canvasElement = await html2canvas(canvas, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: null,
            width: 1080,
            height: 1920
        });
        
        // éšè—canvas
        canvas.style.display = 'none';
        
        // æ˜¾ç¤ºé¢„è§ˆ
        const preview = document.getElementById('preview-image');
        preview.innerHTML = `
            <img src="${canvasElement.toDataURL('image/png')}" 
                 style="width: 100%; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="downloadImage('${canvasElement.toDataURL('image/png')}')">
                    ğŸ’¾ ä¸‹è½½å›¾ç‰‡
                </button>
            </div>
        `;
        
        showSuccess('å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼');
        
    } catch (error) {
        console.error('Failed to generate image:', error);
        showError('ç”Ÿæˆå›¾ç‰‡å¤±è´¥: ' + error.message);
    }
}

// ä¸‹è½½å›¾ç‰‡
function downloadImage(dataUrl) {
    const link = document.createElement('a');
    link.download = `äº¤æ˜“åˆ†äº«-${new Date().getTime()}.png`;
    link.href = dataUrl;
    link.click();
}

// Toastæç¤º
function showError(message) {
    const toast = document.createElement('div');
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000;';
    toast.textContent = 'âŒ ' + message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function showSuccess(message) {
    const toast = document.createElement('div');
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000;';
    toast.textContent = 'âœ… ' + message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// ç”Ÿæˆäº¤æ˜“ç¬”è®°
async function generateTradeNote() {
    if (!selectedTrade) {
        showError('è¯·å…ˆé€‰æ‹©äº¤æ˜“');
        return;
    }
    
    // æŸ¥æ‰¾å¯¹åº”çš„å¼€ä»“/å¹³ä»“äº¤æ˜“
    const isClose = selectedTrade.action === 'CLOSE_LONG' || selectedTrade.action === 'CLOSE_SHORT';
    const openAction = isClose ? 
        (selectedTrade.action === 'CLOSE_LONG' ? 'OPEN_LONG' : 'OPEN_SHORT') :
        (selectedTrade.action === 'OPEN_LONG' ? 'CLOSE_LONG' : 'CLOSE_SHORT');
    
    const relatedTrade = trades.find(t => 
        t.security_info?.symbol === selectedTrade.security_info?.symbol &&
        t.action === openAction &&
        parseFloat(t.quantity) === parseFloat(selectedTrade.quantity) &&
        new Date(t.traded_at) < new Date(selectedTrade.traded_at)
    );
    
    // è®¡ç®—ç›ˆäº
    let pnl = parseFloat(selectedTrade.realized_pnl || 0);
    if (isClose && pnl === 0 && relatedTrade) {
        const openPrice = parseFloat(relatedTrade.price);
        const closePrice = parseFloat(selectedTrade.price);
        const quantity = parseFloat(selectedTrade.quantity);
        
        if (selectedTrade.action === 'CLOSE_LONG') {
            pnl = (closePrice - openPrice) * quantity - parseFloat(selectedTrade.fee || 0) - parseFloat(relatedTrade.fee || 0);
        } else {
            pnl = (openPrice - closePrice) * quantity - parseFloat(selectedTrade.fee || 0) - parseFloat(relatedTrade.fee || 0);
        }
    }
    
    const isProfit = pnl >= 0;
    const symbol = selectedTrade.security_info?.symbol || 'æœªçŸ¥ä»£ç ';
    const name = selectedTrade.security_info?.name || 'è‚¡ç¥¨åç§°';
    
    // åˆ›å»ºäº¤æ˜“ç¬”è®°HTML
    const noteHTML = `
        <div class="trade-note" style="width: 1080px; min-height: 2400px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 50px; font-family: 'Microsoft YaHei', sans-serif; color: white; position: relative; overflow: hidden;">
            <!-- èƒŒæ™¯è£…é¥° -->
            <div style="position: absolute; top: -100px; right: -100px; width: 400px; height: 400px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -100px; left: -100px; width: 300px; height: 300px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
            
            <!-- æ ‡é¢˜ -->
            <div style="text-align: center; margin-bottom: 50px;">
                <h1 style="font-size: 72px; font-weight: 900; margin-bottom: 20px; text-shadow: 0 4px 20px rgba(0,0,0,0.3);">ğŸ“Š äº¤æ˜“ç¬”è®°</h1>
                <div style="font-size: 48px; opacity: 0.9;">${symbol} - ${name}</div>
            </div>
            
            <!-- äº¤æ˜“æ¦‚è§ˆ -->
            <div style="background: rgba(255,255,255,0.15); border-radius: 30px; padding: 35px; margin-bottom: 30px; backdrop-filter: blur(20px); border: 2px solid rgba(255,255,255,0.3);">
                <h2 style="font-size: 48px; margin-bottom: 25px; text-align: center;">ğŸ’° äº¤æ˜“æ¦‚è§ˆ</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; font-size: 36px;">
                    <div>
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">è‚¡ç¥¨ä»£ç </div>
                        <div style="font-weight: bold; font-size: 42px;">${symbol}</div>
                    </div>
                    <div>
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">è‚¡ç¥¨åç§°</div>
                        <div style="font-weight: bold; font-size: 42px;">${name}</div>
                    </div>
                    <div>
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">æœ€ç»ˆè·åˆ©</div>
                        <div style="font-weight: bold; font-size: 48px; color: ${isProfit ? '#00ff88' : '#ff6b6b'};">
                            ${isProfit ? '+' : ''}${pnl.toFixed(2)} æ¸¯å…ƒ
                        </div>
                    </div>
                    <div>
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">æ”¶ç›Šç‡</div>
                        <div style="font-weight: bold; font-size: 48px; color: ${isProfit ? '#00ff88' : '#ff6b6b'};">
                            ${isProfit ? '+' : ''}${(pnl / (parseFloat(selectedTrade.price) * parseFloat(selectedTrade.quantity)) * 100).toFixed(2)}%
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å¼€ä»“ä¿¡æ¯ -->
            <div style="background: rgba(255,255,255,0.15); border-radius: 30px; padding: 35px; margin-bottom: 30px; backdrop-filter: blur(20px); border: 2px solid rgba(255,255,255,0.3);">
                <h2 style="font-size: 48px; margin-bottom: 25px; text-align: center;">ğŸ“ˆ å¼€ä»“ä¿¡æ¯</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; font-size: 36px;">
                    <div>
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">ä¹°å…¥ä»·æ ¼</div>
                        <div style="font-weight: bold; font-size: 42px;">${relatedTrade ? parseFloat(relatedTrade.price).toFixed(3) : 'N/A'}</div>
                    </div>
                    <div>
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">ä¹°å…¥æ•°é‡</div>
                        <div style="font-weight: bold; font-size: 42px;">${relatedTrade ? relatedTrade.quantity : 'N/A'}</div>
                    </div>
                    <div>
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">ä¹°å…¥é‡‘é¢</div>
                        <div style="font-weight: bold; font-size: 42px;">${relatedTrade ? (parseFloat(relatedTrade.price) * parseFloat(relatedTrade.quantity)).toFixed(2) : 'N/A'}</div>
                    </div>
                    <div>
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">å¼€ä»“æ—¶é—´</div>
                        <div style="font-weight: bold; font-size: 32px;">${relatedTrade ? new Date(relatedTrade.traded_at).toLocaleString('zh-CN') : 'N/A'}</div>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <div style="color: rgba(255,255,255,0.7); margin-bottom: 15px; font-size: 32px;">å¼€ä»“å¤‡æ³¨</div>
                    <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; font-size: 28px; line-height: 1.6;">
                        ${relatedTrade && relatedTrade.notes ? relatedTrade.notes : 'æš‚æ— å¤‡æ³¨'}
                    </div>
                </div>
            </div>
            
            <!-- å¹³ä»“ä¿¡æ¯ -->
            <div style="background: rgba(255,255,255,0.15); border-radius: 30px; padding: 35px; margin-bottom: 30px; backdrop-filter: blur(20px); border: 2px solid rgba(255,255,255,0.3);">
                <h2 style="font-size: 48px; margin-bottom: 25px; text-align: center;">${isProfit ? 'ğŸ“ˆ' : 'ğŸ“‰'} å¹³ä»“ä¿¡æ¯</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; font-size: 36px;">
                    <div>
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">å–å‡ºä»·æ ¼</div>
                        <div style="font-weight: bold; font-size: 42px;">${parseFloat(selectedTrade.price).toFixed(3)}</div>
                    </div>
                    <div>
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">å–å‡ºæ•°é‡</div>
                        <div style="font-weight: bold; font-size: 42px;">${selectedTrade.quantity}</div>
                    </div>
                    <div>
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">å–å‡ºé‡‘é¢</div>
                        <div style="font-weight: bold; font-size: 42px;">${(parseFloat(selectedTrade.price) * parseFloat(selectedTrade.quantity)).toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">å¹³ä»“æ—¶é—´</div>
                        <div style="font-weight: bold; font-size: 32px;">${new Date(selectedTrade.traded_at).toLocaleString('zh-CN')}</div>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <div style="color: rgba(255,255,255,0.7); margin-bottom: 15px; font-size: 32px;">å¹³ä»“å¤‡æ³¨</div>
                    <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; font-size: 28px; line-height: 1.6;">
                        ${selectedTrade.notes || 'æš‚æ— å¤‡æ³¨'}
                    </div>
                </div>
            </div>
            
                        
            <!-- åº•éƒ¨ä¿¡æ¯ -->
            <div style="text-align: center; margin-top: 30px; opacity: 0.7; font-size: 24px;">
                <div>ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</div>
                <div style="margin-top: 8px;">ğŸ“Š Stocks-Lab äº¤æ˜“ç®¡ç†ç³»ç»Ÿ</div>
            </div>
        </div>
    `;
    
    // æ¸²æŸ“åˆ°éšè—çš„å®¹å™¨
    const noteCanvas = document.getElementById('share-canvas');
    noteCanvas.innerHTML = noteHTML;
    noteCanvas.style.display = 'block';
    
    try {
        // ç”Ÿæˆå›¾ç‰‡
        const element = noteCanvas.firstElementChild;
        console.log('Element scrollHeight:', element.scrollHeight);
        console.log('Element scrollWidth:', element.scrollWidth);
        console.log('Element offsetHeight:', element.offsetHeight);
        console.log('Element offsetWidth:', element.offsetWidth);
        
        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: null,
            width: 1080,
            height: element.scrollHeight,
            scrollX: 0,
            scrollY: 0,
            windowWidth: element.scrollWidth,
            windowHeight: element.scrollHeight
        });
        
        // éšè—canvas
        noteCanvas.style.display = 'none';
        
        // æ˜¾ç¤ºé¢„è§ˆ
        const preview = document.getElementById('preview-image');
        preview.innerHTML = `
            <img src="${canvas.toDataURL('image/png')}" 
                 style="width: 100%; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="downloadNote('${canvas.toDataURL('image/png')}')">
                    ğŸ’¾ ä¸‹è½½äº¤æ˜“ç¬”è®°
                </button>
            </div>
        `;
        
        showSuccess('äº¤æ˜“ç¬”è®°ç”ŸæˆæˆåŠŸï¼');
        
    } catch (error) {
        console.error('Failed to generate note:', error);
        showError('ç”Ÿæˆäº¤æ˜“ç¬”è®°å¤±è´¥: ' + error.message);
    }
}

// ä¸‹è½½ç¬”è®°
function downloadNote(dataUrl) {
    const link = document.createElement('a');
    link.download = `äº¤æ˜“ç¬”è®°-${new Date().getTime()}.png`;
    link.href = dataUrl;
    link.click();
}

// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', () => {
    loadTrades();
});
</script>

{% endblock %}
